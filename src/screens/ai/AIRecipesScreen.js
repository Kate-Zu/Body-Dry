import React, { useState, useRef, useEffect, useCallback } from 'react';
import {
  View,
  Text,
  StyleSheet,
  SafeAreaView,
  TouchableOpacity,
  ScrollView,
  TextInput,
  KeyboardAvoidingView,
  Platform,
  ActivityIndicator,
  Image,
} from 'react-native';
import { Ionicons } from '@expo/vector-icons';
import { Colors } from '../../constants/colors';
import { PremiumGate } from '../../components/PremiumGate';
import { useTranslation } from '../../i18n';
import { useChatStore } from '../../store';

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ CONTENT CENSORSHIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const BANNED_WORDS = [
  // ‚îÄ‚îÄ 1. Drugs / narcotics / controlled substances (US CSA + EU) ‚îÄ‚îÄ
  '–Ω–∞—Ä–∫–æ—Ç–∏–∫', '–º–∞—Ä–∏—Ö—É–∞–Ω', '–∫–æ–∫–∞—ó–Ω', '–≥–µ—Ä–æ—ó–Ω', '–∞–º—Ñ–µ—Ç–∞–º—ñ–Ω', '–º–µ—Ç–∞–º—Ñ–µ—Ç–∞–º—ñ–Ω',
  '–≥–∞—à–∏—à', '–µ–∫—Å—Ç–∞–∑—ñ', 'lsd', '–º–¥–º–∞', '–∫–∞–Ω–∞–±—ñ—Å', '–æ–ø—ñ–∞—Ç', '–æ–ø—ñ–æ—ó–¥',
  '—Ñ–µ–Ω—Ç–∞–Ω—ñ–ª', '–∫–æ–¥–µ—ó–Ω', '–º–æ—Ä—Ñ—ñ–Ω', '—Ç—Ä–∞–º–∞–¥–æ–ª', '–±–∞—Ä–±—ñ—Ç—É—Ä–∞—Ç', '–±–µ–Ω–∑–æ–¥—ñ–∞–∑–µ–ø—ñ–Ω',
  '–º–µ—Ñ–µ–¥—Ä–æ–Ω', '—Å–ø–∞–π—Å', '—Å–Ω–∞—Ñ', '–∫—Ä–µ–∫', '–º–µ—Å–∫–∞–ª—ñ–Ω', '–ø—Å–∏–ª–æ—Ü–∏–±', '–≥—Ö–±', '–∫–µ—Ç–∞–º—ñ–Ω',
  '–Ω–∞—Ä–∫–æ–º–∞–Ω', '–Ω–∞—Ä–∫–æ–ª–∞–±', '–∑–∞–∫–ª–∞–¥–∫', '–Ω–∞—Ä–∫–æ–¥–∏–ª–µ—Ä', '–Ω–∞—Ä–∫–æ–ª–æ–≥',
  'cocaine', 'heroin', 'marijuana', 'amphetamine', 'methamphetamine', 'ecstasy',
  'cannabis', 'opiate', 'opioid', 'narcotic', 'drug abuse', 'fentanyl',
  'codeine', 'morphine', 'tramadol', 'barbiturate', 'benzodiazepine',
  'mephedrone', 'spice drug', 'crack', 'mescaline', 'psilocybin', 'ghb',
  'ketamine', 'drug dealer', 'drug lab',
  // ‚îÄ‚îÄ 2. Alcohol ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–∞–ª–∫–æ–≥–æ–ª', '–≥–æ—Ä—ñ–ª–∫', '–ø–∏–≤–æ', '–≤–∏–Ω–æ', '–∫–æ–Ω—å—è–∫', '–≤—ñ—Å–∫—ñ', '–∞–±—Å–µ–Ω—Ç',
  '—Å–∞–º–æ–≥–æ–Ω', '—Å–ø–∏—Ä—Ç–Ω', '–ø–æ—Ö–º—ñ–ª', '–±—É—Ö–ª', '–∑–∞–ø—ñ–π', '–∞–ª–∫–æ–∑–∞–ª–µ–∂–Ω',
  'alcohol', 'vodka', 'whiskey', 'beer', 'wine', 'liquor', 'hangover',
  'drinking', 'binge drink', 'moonshine', 'booze',
  // ‚îÄ‚îÄ 3. Pornography / sexual content / sexual services ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–ø–æ—Ä–Ω–æ', '–ø–æ—Ä–Ω–æ–≥—Ä–∞—Ñ', 'xxx', '—Ö–µ–Ω—Ç–∞–π', 'hentai', '–µ—Ä–æ—Ç–∏–∫', '–µ—Ä–æ—Ç–∏—á–Ω',
  '—Å—Ç—Ä–∏–ø', '—Å—Ç—Ä–∏–ø—Ç–∏–∑', '—Å–µ–∫—Å', '—Å–µ–∫—Å—É–∞–ª—å–Ω', '—Å–µ–∫—Å-–ø–æ—Å–ª—É–≥', '—ñ–Ω—Ç–∏–º-–ø–æ—Å–ª—É–≥',
  '–µ—Å–∫–æ—Ä—Ç', '–ø—Ä–æ—Å—Ç–∏—Ç—É—Ü', '–ø—Ä–æ—Å—Ç–∏—Ç—É—Ç–∫', '–ø–æ–≤—ñ—ó', '–±–æ—Ä–¥–µ–ª—ñ', '–±–æ—Ä–¥–µ–ª',
  '—Å—É—Ç–µ–Ω–µ—Ä', '–º–∞—Å–∞–∂ –µ—Ä–æ—Ç–∏—á', '—ñ–Ω—Ç–∏–º', '–∑–±–æ—á–µ–Ω', '–ø–µ–¥–æ—Ñ—ñ–ª', '–∑–æ–æ—Ñ—ñ–ª',
  '—ñ–Ω—Ü–µ—Å—Ç', '–≥—Ä—É–º—ñ–Ω–≥', '—Å–µ–∫—Å—É–∞–ª—ñ–∑–∞—Ü', '–æ–Ω–ª—ñ—Ñ–∞–Ω—Å', '–≤–µ–±–∫–∞–º',
  'porn', 'pornograph', 'erotic', 'stripper', 'striptease', 'sexual',
  'sex service', 'escort service', 'prostitut', 'brothel', 'pimp',
  'erotic massage', 'intimat', 'perver', 'pedophil', 'zoophil',
  'incest', 'grooming', 'sexuali', 'onlyfans', 'webcam model',
  // ‚îÄ‚îÄ 4. BDSM / fetish / kink ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–±–¥—Å–º', 'bdsm', '—Å–∞–¥–æ–º–∞–∑–æ—Ö—ñ–∑', 'sadomasoch', '—Ñ–µ—Ç–∏—à', 'fetish',
  '–±–æ–Ω–¥–∞–∂', 'bondage', '–¥–æ–º—ñ–Ω–∞—Ü', '–¥–æ–º—ñ–Ω–∞—Ç—Ä–∏–∫—Å', 'dominatrix',
  '—Å–∞–±–º—ñ—Å', 'submissi',
  // ‚îÄ‚îÄ 5. Tobacco & smoking ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '—Å–∏–≥–∞—Ä–µ—Ç', '—Ç—é—Ç—é–Ω', '–≤–µ–π–ø', '–∫–∞–ª—å—è–Ω', '–Ω—ñ–∫–æ—Ç–∏–Ω', '–∫—É—Ä—ñ–Ω–Ω—è', '—Å–Ω—é—Å',
  'cigarette', 'tobacco', 'vape', 'hookah', 'nicotine', 'smoking', 'snus',
  'e-cigarette', 'juul',
  // ‚îÄ‚îÄ 6. Anabolic / performance-enhancing drugs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '—Å—Ç–µ—Ä–æ—ó–¥', '–∞–Ω–∞–±–æ–ª', '—Ç–µ—Å—Ç–æ—Å—Ç–µ—Ä–æ–Ω —ñ–Ω\'—î–∫—Ü', '–µ—Ä–∏—Ç—Ä–æ–ø–æ–µ—Ç–∏–Ω',
  '—Å–æ–º–∞—Ç–æ—Ç—Ä–æ–ø—ñ–Ω', '–≥–æ—Ä–º–æ–Ω —Ä–æ—Å—Ç—É —ñ–Ω\'—î–∫—Ü', '—Ç—Ä–µ–Ω–±–æ–ª–æ–Ω', '–Ω–∞–Ω–¥—Ä–æ–ª–æ–Ω',
  '–∫–ª–µ–Ω–±—É—Ç–µ—Ä–æ–ª', '–¥–Ω–ø', '—Å–∏–±—É—Ç—Ä–∞–º—ñ–Ω', '–µ—Ñ–µ–¥—Ä–∏–Ω',
  'steroid', 'anabolic', 'erythropoietin', 'somatotropin', 'hgh injection',
  'trenbolone', 'nandrolone', 'clenbuterol', 'dnp', 'sibutramine', 'ephedrine',
  '–¥–æ–ø—ñ–Ω–≥', 'doping',
  // ‚îÄ‚îÄ 7. Self-harm / suicide ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '—Å—É—ó—Ü–∏–¥', '—Å–∞–º–æ–≥—É–±—Å—Ç–≤', '—Å–∞–º–æ—É—à–∫–æ–¥–∂', '—Å–∞–º–æ–∫–∞–ª—ñ—á–µ–Ω', '—Ä—ñ–∑–∞—Ç–∏ –≤–µ–Ω–∏',
  '–ø–æ–≤—ñ—Å–∏—Ç', '—Å—Ç—Ä–∏–±–Ω—É—Ç–∏ –∑', '–æ—Ç—Ä—É—ó—Ç —Å–µ–±', '—Ö–æ—á—É –ø–æ–º–µ—Ä—Ç–∏', '–Ω–µ —Ö–æ—á—É –∂–∏—Ç–∏',
  'suicide', 'self-harm', 'self-injury', 'cut myself', 'kill myself',
  'want to die', 'end my life',
  // ‚îÄ‚îÄ 8. Eating disorders (NEDA / EU clinical guidelines) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–∞–Ω–æ—Ä–µ–∫—Å—ñ', '–∞–Ω–æ—Ä–µ–∫—Å–∏', '–±—É–ª—ñ–º—ñ', '–±—É–ª–∏–º–∏', '–±–ª—é–≤–æ—Ç', '–æ—á–∏—â–µ–Ω',
  '–ø—Ä–æ–Ω–æ—Å–Ω', '–ø—Ä–æ–º—ñ–≤–∞–Ω', '—è–∫ –±–ª—é–≤–∞—Ç–∏', '—è–∫ –Ω–µ —ó—Å—Ç–∏', '–≥–æ–ª–æ–¥—É–≤–∞–Ω',
  '–¥—ñ—î—Ç–∞ 500 –∫–∫–∞–ª', '–¥—ñ—î—Ç–∞ 300', '–Ω—É–ª—å–æ–≤–∞ –¥—ñ—î—Ç–∞', '–≤–æ–¥–Ω–∞ –¥—ñ—î—Ç–∞',
  '—Å—É—à–∫–∞ –Ω–µ–±–µ–∑–ø–µ—á–Ω', '—è–∫ —Å—Ç–∞—Ç–∏ —Ö—É–¥', '—Ö—É–¥–∏–π —ñ–¥–µ–∞–ª', 'thinspo', '—Ç—ñ–Ω—Å–ø–æ',
  '–ø—Ä–æ–∑–∞–∫ –¥–ª—è —Å—Ö—É–¥', '–¥—ñ—É—Ä–µ—Ç–∏–∫ –¥–ª—è —Å—Ö—É–¥',
  'anorexi', 'bulimi', 'purging', 'binge purge', 'pro-ana', 'pro-mia',
  'thinspo', 'bonespo', 'how to starve', 'water fast extreme',
  'zero calorie diet', 'laxative diet', 'how to vomit',
  // ‚îÄ‚îÄ 9. Weapons / violence / terrorism ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–∑–±—Ä–æ—è', '–≤–∏–±—É—Ö—ñ–≤–∫', '–≤–∏–±—É—Ö–æ–≤', '–±–æ–º–±', '—Ç–µ—Ä–æ—Ä–∏—Å', '—Ç–µ—Ä–æ—Ä–∏—Å—Ç',
  '—Ç–µ—Ä–∞–∫—Ç', '—è–∫ –∑—Ä–æ–±–∏—Ç–∏ –±–æ–º–±', '—è–∫ –≤–±–∏—Ç–∏', '–Ω–∞—Å–∏–ª—å—Å—Ç–≤', '–∫–∞—Ç—É–≤–∞–Ω–Ω',
  'weapon', 'explosive', 'bomb', 'terrorist', 'terrorism', 'how to kill',
  'violence', 'torture', 'firearm', 'gun', 'assault rifle',
  // ‚îÄ‚îÄ 10. Gambling ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–∞–∑–∞—Ä—Ç–Ω', '–∫–∞–∑–∏–Ω–æ', '—Å—Ç–∞–≤–∫', '–±—É–∫–º–µ–∫–µ—Ä', '–ª–æ—Ç–µ—Ä–µ', '–ø–æ–∫–µ—Ä',
  '—Ä—É–ª–µ—Ç–∫', '—Å–ª–æ—Ç –º–∞—à–∏–Ω', '–æ–Ω–ª–∞–π–Ω –∫–∞–∑–∏–Ω–æ',
  'gambling', 'casino', 'betting', 'bookmaker', 'lottery', 'poker',
  'slot machine', 'online casino',
  // ‚îÄ‚îÄ 11. Hate speech / discrimination ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '—Ä–∞—Å–∏–∑–º', '—Ä–∞—Å–∏—Å—Ç', '–Ω–∞—Ü–∏–∑–º', '–Ω–∞—Ü–∏—Å—Ç', '—Ñ–∞—à–∏–∑–º', '—Ñ–∞—à–∏—Å—Ç',
  '–∫—Å–µ–Ω–æ—Ñ–æ–±', '–≥–æ–º–æ—Ñ–æ–±', '–∞–Ω—Ç–∏—Å–µ–º—ñ—Ç', '—à–æ–≤—ñ–Ω—ñ–∑', '–±—ñ–ª–∏–π —Å—É–ø—Ä–µ–º–∞—Å',
  'racism', 'racist', 'nazism', 'nazi', 'fascism', 'fascist',
  'xenophob', 'homophob', 'antisemit', 'white supremac', 'hate speech',
  // ‚îÄ‚îÄ 12. Dangerous medical misinformation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–≤—ñ–¥–±—ñ–ª—é–≤–∞—á –ª—ñ–∫—É—î', '–ø–µ—Ä–µ–∫–∏—Å –ø–∏—Ç–∏', '—Å–µ—á–æ—Ç–µ—Ä–∞–ø—ñ', '—É—Ä–∏–Ω–æ—Ç–µ—Ä–∞–ø—ñ',
  '–∞–Ω—Ç–∏–≤–∞–∫—Å–µ—Ä', '–∞–Ω—Ç–∏–≤–∞–∫—Ü–∏–Ω', '—á—ñ–ø —É –≤–∞–∫—Ü–∏–Ω', '–ø\'—è—Ç–∏ –¥–∂—ñ',
  'bleach cure', 'drink peroxide', 'urine therapy', 'anti-vax',
  'antivaccin', 'chip in vaccine', '5g cause',
  // ‚îÄ‚îÄ 13. Organ trafficking / black market ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–ø—Ä–æ–¥–∞–∂ –æ—Ä–≥–∞–Ω', '–∫—É–ø—ñ–≤–ª—è –æ—Ä–≥–∞–Ω', '–∫—É–ø–∏—Ç–∏ –æ—Ä–≥–∞–Ω', '–ø—Ä–æ–¥–∞—Ç–∏ –æ—Ä–≥–∞–Ω',
  '—Ç–æ—Ä–≥—ñ–≤–ª—è –æ—Ä–≥–∞–Ω', '—á–æ—Ä–Ω–∏–π —Ä–∏–Ω–æ–∫', '—á–æ—Ä–Ω–∏–π —Ä–∏–Ω–æ–∫ –æ—Ä–≥–∞–Ω', '–Ω–∏—Ä–∫ –Ω–∞ –ø—Ä–æ–¥–∞–∂',
  '–ø–µ—á—ñ–Ω–∫–∞ –Ω–∞ –ø—Ä–æ–¥–∞–∂', '–¥–æ–Ω–æ—Ä –∑–∞ –≥—Ä–æ—à—ñ', '–Ω–µ–ª–µ–≥–∞–ª—å–Ω–∞ —Ç—Ä–∞–Ω—Å–ø–ª–∞–Ω—Ç–∞—Ü',
  '–∫–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥', '—Ç–æ—Ä–≥—ñ–≤–ª—è –ª—é–¥—å–º', '—Ç—Ä–∞—Ñ—ñ–∫—ñ–Ω–≥',
  'organ traffick', 'organ sale', 'sell organ', 'buy organ', 'organ trade',
  'black market organ', 'kidney for sale', 'liver for sale',
  'illegal transplant', 'human trafficking', 'black market', 'contraband',
  'organ harvest', 'organ broker',
  // ‚îÄ‚îÄ 14. Money laundering / fraud / illegal finance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–≤—ñ–¥–º–∏–≤–∞–Ω–Ω', '–≤—ñ–¥–º–∏–≤–∞–Ω–Ω—è –≥—Ä–æ—à', '–æ–±–º–∏–≤–∞–Ω–Ω', '–æ–±–º–∏–≤–∞–Ω–Ω—è –≥—Ä–æ—à',
  '–ª–µ–≥–∞–ª—ñ–∑–∞—Ü—ñ—è –¥–æ—Ö–æ–¥', '–ª–µ–≥–∞–ª—ñ–∑–∞—Ü—ñ—è –∫–æ—à—Ç', '—Ç—ñ–Ω—å–æ–≤–∞ –µ–∫–æ–Ω–æ–º—ñ–∫',
  '—Ç—ñ–Ω—å–æ–≤–∏–π –±—ñ–∑–Ω–µ—Å', '–Ω–µ–∑–∞–∫–æ–Ω–Ω–∏–π –æ–±–º—ñ–Ω', '–æ–±–º—ñ–Ω –≤–∞–ª—é—Ç –Ω–µ–ª–µ–≥–∞–ª',
  '—Ñ–∞–ª—å—à–∏–≤', '—Ñ–∞–ª—å—à–∏–≤–æ–º–æ–Ω–µ—Ç–Ω', '–ø—ñ–¥—Ä–æ–±–∫–∞ –≥—Ä–æ—à', '–ø—ñ–¥—Ä–æ–±–∫–∞ –¥–æ–∫—É–º–µ–Ω—Ç',
  '—à–∞—Ö—Ä–∞–π—Å—Ç–≤', '–∞—Ñ–µ—Ä', '—Ñ—ñ–Ω–∞–Ω—Å–æ–≤–∞ –ø—ñ—Ä–∞–º—ñ–¥', '–ø–æ–Ω—Ü—ñ —Å—Ö–µ–º',
  '—É—Ö–∏–ª–µ–Ω–Ω—è –≤—ñ–¥ –ø–æ–¥–∞—Ç–∫', '–æ—Ñ—à–æ—Ä', '–∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–Ω–∞ —Å—Ö–µ–º',
  '—Ö–∞–±–∞—Ä', '–∫–æ—Ä—É–ø—Ü', '—Ä–æ–∑–∫—Ä–∞–¥–∞–Ω', '–∫—Ä–∞–¥—ñ–∂–∫', '—Ä–æ–∑–±—ñ–π', '–≤–∏–º–∞–≥–∞–Ω–Ω',
  '—Ä–µ–∫–µ—Ç', '–∫—ñ–±–µ—Ä–∑–ª–æ—á–∏–Ω', '—Ö–∞–∫–µ—Ä—Å—Ç–≤', '—Ñ—ñ—à–∏–Ω–≥', '–∫–∞—Ä–¥–∏–Ω–≥',
  'money launder', 'launder money', 'wash money', 'illegal exchange',
  'counterfeit', 'forgery', 'forged document', 'fraud', 'scam',
  'ponzi scheme', 'pyramid scheme', 'tax evasion', 'offshore scheme',
  'crypto scam', 'bribery', 'bribe', 'corruption', 'embezzlement',
  'extortion', 'racketeering', 'cybercrime', 'hacking', 'phishing',
  'carding', 'identity theft', 'dark web', 'darknet',
  // ‚îÄ‚îÄ 15. Smuggling / illegal transportation ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  '–∫–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥', '–Ω–µ–∑–∞–∫–æ–Ω–Ω–µ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω', '–Ω–µ–ª–µ–≥–∞–ª—å–Ω–µ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω',
  '–Ω–µ–ª–µ–≥–∞–ª—å–Ω–∏–π –ø–µ—Ä–µ—Ç—ñ', '–ø–µ—Ä–µ—Ç–∏–Ω –∫–æ—Ä–¥–æ–Ω –Ω–µ–ª–µ–≥–∞–ª', '–ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è –Ω–∞—Ä–∫–æ—Ç–∏–∫',
  '–ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—è –∑–±—Ä–æ—ó', '–Ω–µ–ª–µ–≥–∞–ª—å–Ω–∞ –º—ñ–≥—Ä–∞—Ü', '–ø–µ—Ä–µ–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ª—é–¥–µ–π',
  '–∫–∞–Ω–∞–ª—ñ –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω', '—Ç—É–Ω–µ–ª—ñ –∫–æ–Ω—Ç—Ä–∞–±–∞–Ω–¥',
  'smuggling', 'smuggle', 'illegal transport', 'illegal shipment',
  'illegal border crossing', 'drug trafficking', 'arms trafficking',
  'illegal immigration', 'people smuggling', 'smuggling tunnel',
  'illicit trade', 'illegal cargo',
  // ‚îÄ‚îÄ 16. Bypass variants: Russian equivalents / slang / euphemisms ‚îÄ‚îÄ
  // drugs (ru)
  '–Ω–∞—Ä–∫–æ—Ç–∞', '–¥—É—Ä—å', '—Ç—Ä–∞–≤–∫–∞', '–∫–æ—Å—è–∫', '—à–∏—Ä–∫–∞', '–ø–ª–∞–Ω', '–∫–∞–π—Ñ',
  '—Ç–æ—Ä—á–∞—Ç—å', '—Ç–æ—Ä—á–æ–∫', '–¥—É–Ω—É—Ç—å', '–≤–º–∞–∑–∞—Ç—å', '–Ω—é—Ö–∞—Ç—å', '–∫–æ–ª–æ—Ç—å—Å—è',
  '—à–∏—Ä—è—Ç—å—Å—è', '–±–∞—è–Ω', '–¥–æ–∑–Ω—è–∫', '–ø—Ä–∏—Ö–æ–¥', '–∫—É–º–∞—Ä', '–æ–±–¥–æ–ª–±–∞–Ω',
  '–æ–±–∫—É—Ä–µ–Ω', '—Å–ø–∏–¥–æ–∑–Ω', '–Ω–∞—Ä–∏–∫', '–≤–µ—â–µ—Å—Ç–≤–∞', '—Ö—ñ–º—ñ—è', '—Ö—ñ–º–∫–∞',
  '—Å–æ–ª—ñ –¥–ª—è –≤–∞–Ω–Ω', 'bath salt',
  // alcohol (ru slang)
  '–±—É—Ö–∞—Ç—å', '–±—É—Ö–æ–π', '–±—É—Ö–ª–æ', '–Ω–∞–∂—Ä–∞—Ç—å', '–∫–≤–∞—Å–∏—Ç', '—Å–∏–Ω—è–∫',
  '–≤–æ–¥—è—Ä–∞', '–ø–∞–ª—ë–Ω–∫', '—Å–ø–∏—Ä—Ç', '–Ω–∞—Å—Ç–æ–π–∫',
  // sexual (ru + euphemisms)
  '–ø—É—Ç–∞–Ω', '—à–ª—é—Ö', '–±–ª—è–¥—å', '–±–ª—è—Ç—å', '—à–∞–ª–∞–≤', '–¥–∞–≤–∞–ª–∫',
  '–º–∏–Ω–µ—Ç', '–æ—Ç—Å–æ—Å', '—Ç—Ä–∞—Ö', '–ø–æ—Ä–Ω—É—Ö', '–ø–æ—Ä–Ω—É—à', '–ø–æ—Ä–µ–≤–æ',
  '—Ä–∞–∑–≤—Ä–∞—Ç', '–∏–∑–≤—Ä–∞—â–µ–Ω', '—Å–æ–¥–æ–º—ñ', '—Å–æ–¥–æ–º–∏', '–æ—Ä–≥—ñ', '–æ—Ä–≥–∏—è',
  '—Ö—É–π', '—Ö—É—è', '—Ö—É–µ', '—Ö—É—ñ', '–ø–∏–∑–¥', '–ø—ñ–∑–¥', '—ó–±–∞—Ç', '–µ–±–∞—Ç',
  '—î–±–∞–Ω', '—ó–±–∞–Ω', '—ë–±–∞–Ω', '–µ–±–∞–Ω', '–ø–∏–∑–¥–µ—Ü', '–ø—ñ–∑–¥–µ—Ü—å',
  'blowjob', 'handjob', 'orgy', 'orgasm', 'dildo', 'vibrator',
  'hookup', 'booty call', 'sugar daddy', 'sugar baby', 'nude',
  'nudes', 'dick pic', 'sexting', 'camgirl', 'chaturbate',
  // self-harm (ru + euphemisms)
  '—Å—É–∏—Ü–∏–¥', '–ø–æ–∫–æ–Ω—á–∏—Ç—å —Å —Å–æ–±–æ–π', '–ø–æ–≤–µ—Å–∏—Ç—å—Å—è', '–≤—Å–∫—Ä—ã—Ç—å –≤–µ–Ω—ã',
  '–ø—Ä—ã–≥–Ω—É—Ç—å —Å –∫—Ä—ã—à', '–æ—Ç—Ä–∞–≤–∏—Ç—å—Å—è', '—Ö–æ—á—É —É–º–µ—Ä–µ—Ç—å',
  '–Ω–µ —Ö–æ—á—É –∂–∏—Ç—å', '–ø–æ—Ä–µ–∑–∞—Ç—å —Å–µ–±', '–Ω–∞–Ω–µ—Å—Ç–∏ —Å–µ–±–µ',
  // eating disorders (ru + euphemisms)
  '–∞–Ω–æ—Ä–µ–∫—Å–∏—è', '–±—É–ª–∏–º–∏—è', '–±–ª–µ–≤–∞—Ç—å', '–∫–∞–∫ –Ω–µ –µ—Å—Ç—å', '–≥–æ–ª–æ–¥–æ–≤–∫–∞',
  '–Ω—É–ª–µ–≤–∞—è –¥–∏–µ—Ç–∞', '–¥–∏–µ—Ç–∞ 500', '–∫–∞–∫ —Å—Ç–∞—Ç—å —Ö—É–¥–æ–π', '–∫–∞–∫ –ø–æ—Ö—É–¥–µ—Ç—å –±—ã—Å—Ç—Ä–æ',
  '—Å–ª–∞–±–∏—Ç–µ–ª—å–Ω', '–º–æ—á–µ–≥–æ–Ω–Ω', '—Ä–≤–æ—Ç–Ω',
  // weapons (ru)
  '–æ—Ä—É–∂–∏–µ', '–ø–∏—Å—Ç–æ–ª–µ—Ç', '–∞–≤—Ç–æ–º–∞—Ç', '–≤–∑—Ä—ã–≤—á–∞—Ç–∫', '–∫–∞–∫ —Å–¥–µ–ª–∞—Ç—å –±–æ–º–±',
  '–∫–∞–∫ —É–±–∏—Ç—å', '–Ω–æ–∂–µ–≤–æ–µ', '—Ö–æ–ª–æ–¥–Ω–æ–µ –æ—Ä—É–∂–∏',
  // hate (ru)
  '—Ä–∞—Å–∏–∑–º', '–Ω–∞—Ü–∏–∑–º', '—Ñ–∞—à–∏–∑–º', '—Ä–∞—Å–∏—Å—Ç', '–Ω–∞—Ü–∏—Å—Ç', '—Ñ–∞—à–∏—Å—Ç',
  '—Ö–æ—Ö–æ–ª', '–∫–∞—Ü–∞–ø', '–∂–∏–¥', '–Ω–∏–≥–µ—Ä', '–Ω–µ–≥—Ä', '—á—É—Ä–∫', '—á—É—á–º–µ–∫',
  'nigger', 'nigga', 'faggot', 'kike', 'spic', 'chink', 'slur',
  // abbrevations & coded
  'mdma', '–º–¥–º–∞', 'lsd', '–ª—Å–¥', 'thc', '—Ç–≥–∫', 'cbd',
  'cp ', ' cp', 'csam', 'nsfw', 'r34', 'rule34', 'gore',
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ TEXT NORMALIZATION (anti-bypass) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const HOMOGLYPH_MAP = {
  '–∞': 'a', '–æ': 'o', '–µ': 'e', '—ñ': 'i', '—É': 'y', '—Ä': 'p',
  '—Å': 'c', '—Ö': 'x', '–∫': 'k', '–Ω': 'h', '–≤': 'b', '–º': 'm',
  '—Ç': 't',
  '0': 'o', '1': 'i', '3': 'e', '4': 'a', '5': 's', '7': 't',
  '8': 'b', '9': 'g', '@': 'a',
  '$': 's', '!': 'i', '|': 'l', '+': 't',
};

const censorNormalize = (text) => {
  let s = text.toLowerCase();
  s = s.replace(/[\u200B-\u200F\u2028-\u202F\uFEFF\u00AD]/g, '');
  s = s.replace(/([a-z–∞-—è—ñ—ó—î“ë])[.\-_*‚Ä¢¬∑~]+(?=[a-z–∞-—è—ñ—ó—î“ë])/gi, '$1');
  s = s.replace(/(?<=^|[^a-z–∞-—è—ñ—ó—î“ë])([a-z–∞-—è—ñ—ó—î“ë])\s+(?=[a-z–∞-—è—ñ—ó—î“ë](?:\s|$|[^a-z–∞-—è—ñ—ó—î“ë]))/gi, '$1');
  s = s.replace(/\s+/g, ' ');
  let normalized = '';
  for (const ch of s) {
    normalized += HOMOGLYPH_MAP[ch] || ch;
  }
  return { cleaned: s, normalized };
};

const containsBannedContent = (text) => {
  const { cleaned, normalized } = censorNormalize(text);
  for (const variant of [cleaned, normalized]) {
    const noSpaces = variant.replace(/\s/g, '');
    for (const w of BANNED_WORDS) {
      if (variant.includes(w) || noSpaces.includes(w)) return true;
    }
  }
  return false;
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ RECIPE ANALYSIS HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Analyze a set of recipes and produce a nutritional insight string
const analyzeRecipes = (recipes, intent, t) => {
  if (!recipes || recipes.length === 0) return null;

  const avgCal = Math.round(recipes.reduce((s, r) => s + r.calories, 0) / recipes.length);
  const avgProt = Math.round(recipes.reduce((s, r) => s + r.protein, 0) / recipes.length);
  const maxProtRecipe = recipes.reduce((max, r) => r.protein > max.protein ? r : max, recipes[0]);
  const minCalRecipe = recipes.reduce((min, r) => r.calories < min.calories ? r : min, recipes[0]);

  const lines = [];

  // Goal-specific analysis
  if (intent && intent.goal) {
    if (intent.goal === 'dry' || intent.goal === 'loss') {
      lines.push(t('aiRecipes.analysisLowCal'));
      lines.push(`${t('aiRecipes.analysisAvgCal')}: ${avgCal} ${t('diary.kcal')}, ${t('aiRecipes.analysisAvgProt')}: ${avgProt}${t('units.g')}`);
      if (minCalRecipe) {
        lines.push(`${t('aiRecipes.analysisLowestCal')}: "${minCalRecipe.name}" ‚Äî ${minCalRecipe.calories} ${t('diary.kcal')}`);
      }
    } else if (intent.goal === 'gain') {
      lines.push(t('aiRecipes.analysisHighProt'));
      lines.push(`${t('aiRecipes.analysisAvgCal')}: ${avgCal} ${t('diary.kcal')}, ${t('aiRecipes.analysisAvgProt')}: ${avgProt}${t('units.g')}`);
      if (maxProtRecipe) {
        lines.push(`${t('aiRecipes.analysisMostProt')}: "${maxProtRecipe.name}" ‚Äî ${maxProtRecipe.protein}${t('units.g')} ${t('aiRecipes.proteinShort')}`);
      }
    }
  } else {
    // General analysis
    lines.push(`üìä ${t('aiRecipes.analysisGeneral')}:`);
    lines.push(`${t('aiRecipes.analysisAvgCal')}: ${avgCal} ${t('diary.kcal')}, ${t('aiRecipes.analysisAvgProt')}: ${avgProt}${t('units.g')}`);
    if (maxProtRecipe && maxProtRecipe.protein >= 25) {
      lines.push(`üí™ ${t('aiRecipes.analysisMostProt')}: "${maxProtRecipe.name}" ‚Äî ${maxProtRecipe.protein}${t('units.g')}`);
    }
    if (minCalRecipe && minCalRecipe.calories <= 250) {
      lines.push(`ü•ó ${t('aiRecipes.analysisLowestCal')}: "${minCalRecipe.name}" ‚Äî ${minCalRecipe.calories} ${t('diary.kcal')}`);
    }
  }

  // Balanced meal tips
  if (avgProt < 15) {
    lines.push(`‚ö†Ô∏è ${t('aiRecipes.analysisTipLowProt')}`);
  }
  if (avgCal > 400) {
    lines.push(`üí° ${t('aiRecipes.analysisTipHighCal')}`);
  }

  return lines.join('\n');
};

// Analyze a single generated recipe
const analyzeGeneratedRecipe = (recipe, t) => {
  const lines = [];
  lines.push(`üìä ${t('aiRecipes.analysisGeneral')}:`);
  lines.push(`${t('aiRecipes.analysisCalories')}: ${recipe.calories} ${t('diary.kcal')}, ${t('aiRecipes.proteinShort')}: ${recipe.protein}${t('units.g')}`);

  if (recipe.protein >= 25) {
    lines.push(`üí™ ${t('aiRecipes.analysisGoodProt')}`);
  } else if (recipe.protein < 15) {
    lines.push(`‚ö†Ô∏è ${t('aiRecipes.analysisTipLowProt')}`);
  }

  if (recipe.calories <= 300) {
    lines.push(`ü•ó ${t('aiRecipes.analysisLightMeal')}`);
  } else if (recipe.calories >= 450) {
    lines.push(`üî• ${t('aiRecipes.analysisHeavyMeal')}`);
  }

  const ingredientCount = recipe.ingredients.length;
  if (ingredientCount <= 4) {
    lines.push(`‚úÖ ${t('aiRecipes.analysisSimple')}`);
  } else if (ingredientCount >= 7) {
    lines.push(`üë®‚Äçüç≥ ${t('aiRecipes.analysisComplex')}`);
  }

  return lines.join('\n');
};

// Recipe database ‚Äî requiredProducts contains the core products needed for the recipe
// (common pantry items like oil, salt, pepper, spices are excluded from matching)
const RECIPE_DATABASE = [
  {
    name: '–ö—É—Ä–∫–∞ –∑ –æ–≤–æ—á–∞–º–∏ –Ω–∞ –≥—Ä–∏–ª—ñ',
    time: '30 —Ö–≤',
    calories: 320,
    protein: 35,
    requiredProducts: ['–∫—É—Ä–∫–∞', '–∫–∞–±–∞—á–æ–∫', '–ø–µ—Ä–µ—Ü—å'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±—ñ–ª–æ–∫', '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É'],
    ingredients: [
      '–ö—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞ - 200–≥',
      '–ö–∞–±–∞—á–æ–∫ - 100–≥',
      '–ë–æ–ª–≥–∞—Ä—Å—å–∫–∏–π –ø–µ—Ä–µ—Ü—å - 1—à—Ç',
      '–û–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è - 1 —Å—Ç.–ª.',
      '–°–ø–µ—Ü—ñ—ó –∑–∞ —Å–º–∞–∫–æ–º',
    ],
    instructions: '–ù–∞—Ä—ñ–∑–∞—Ç–∏ –∫—É—Ä–∫—É —Ç–∞ –æ–≤–æ—á—ñ. –ó–∞–º–∞—Ä–∏–Ω—É–≤–∞—Ç–∏ –≤ –æ–ª–∏–≤–∫–æ–≤—ñ–π –æ–ª—ñ—ó –∑—ñ —Å–ø–µ—Ü—ñ—è–º–∏ –Ω–∞ 15 —Ö–≤. –ì–æ—Ç—É–≤–∞—Ç–∏ –Ω–∞ –≥—Ä–∏–ª—ñ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ.',
  },
  {
    name: '–ü—Ä–æ—Ç–µ—ó–Ω–æ–≤–∏–π —Å–º—É–∑—ñ',
    time: '5 —Ö–≤',
    calories: 250,
    protein: 25,
    requiredProducts: ['–±–∞–Ω–∞–Ω', '–º–æ–ª–æ–∫–æ', '–ø—Ä–æ—Ç–µ—ó–Ω'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '–ø–µ—Ä–µ–∫—É—Å', '—Å–æ–ª–æ–¥–∫', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '—à–≤–∏–¥–∫'],
    ingredients: [
      '–ë–∞–Ω–∞–Ω - 1—à—Ç',
      '–ú–æ–ª–æ–∫–æ 1.5% - 200–º–ª',
      '–ü—Ä–æ—Ç–µ—ó–Ω - 1 –ø–æ—Ä—Ü—ñ—è',
      '–ê—Ä–∞—Ö—ñ—Å–æ–≤–∞ –ø–∞—Å—Ç–∞ - 1 —Å—Ç.–ª.',
    ],
    instructions: '–í—Å—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –∑–±–∏—Ç–∏ –±–ª–µ–Ω–¥–µ—Ä–æ–º –¥–æ –æ–¥–Ω–æ—Ä—ñ–¥–Ω–æ—ó –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ü—ñ—ó.',
  },
  {
    name: '–û–º–ª–µ—Ç –∑ –æ–≤–æ—á–∞–º–∏',
    time: '15 —Ö–≤',
    calories: 280,
    protein: 22,
    requiredProducts: ['—è–π—Ü', '–ø–æ–º—ñ–¥–æ—Ä', '—Å–∏—Ä'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É', '—à–≤–∏–¥–∫'],
    ingredients: [
      '–Ø–π—Ü—è - 3—à—Ç',
      '–ü–æ–º—ñ–¥–æ—Ä - 1—à—Ç',
      '–®–ø–∏–Ω–∞—Ç - 50–≥',
      '–°–∏—Ä —Ç–≤–µ—Ä–¥–∏–π - 30–≥',
      '–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å –∑–∞ —Å–º–∞–∫–æ–º',
    ],
    instructions: '–ó–±–∏—Ç–∏ —è–π—Ü—è, –¥–æ–¥–∞—Ç–∏ –Ω–∞—Ä—ñ–∑–∞–Ω—ñ –æ–≤–æ—á—ñ —Ç–∞ —Ç–µ—Ä—Ç–∏–π —Å–∏—Ä. –í–∏–ª–∏—Ç–∏ –Ω–∞ —Ä–æ–∑—ñ–≥—Ä—ñ—Ç—É —Å–∫–æ–≤–æ—Ä–æ–¥—É. –ì–æ—Ç—É–≤–∞—Ç–∏ –ø—ñ–¥ –∫—Ä–∏—à–∫–æ—é 5-7 —Ö–≤.',
  },
  {
    name: '–°–∞–ª–∞—Ç –¶–µ–∑–∞—Ä –∑ –∫—É—Ä–∫–æ—é',
    time: '20 —Ö–≤',
    calories: 350,
    protein: 30,
    requiredProducts: ['–∫—É—Ä–∫–∞', '—Å–∞–ª–∞—Ç', '–ø–∞—Ä–º–µ–∑–∞–Ω'],
    tags: ['–æ–±—ñ–¥', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '–ª–µ–≥–∫'],
    ingredients: [
      '–ö—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞ - 150–≥',
      '–°–∞–ª–∞—Ç –†–æ–º–∞–Ω–æ - 100–≥',
      '–ü–∞—Ä–º–µ–∑–∞–Ω - 30–≥',
      '–°—É—Ö–∞—Ä–∏–∫–∏ - 30–≥',
      '–°–æ—É—Å –¶–µ–∑–∞—Ä - 2 —Å—Ç.–ª.',
    ],
    instructions: '–û–±—Å–º–∞–∂–∏—Ç–∏ –∫—É—Ä–∫—É –Ω–∞ –≥—Ä–∏–ª—ñ, –Ω–∞—Ä—ñ–∑–∞—Ç–∏. –ó—ñ–±—Ä–∞—Ç–∏ —Å–∞–ª–∞—Ç –∑ –ª–∏—Å—Ç—è, –∫—É—Ä–∫–∏, —Å—É—Ö–∞—Ä–∏–∫—ñ–≤. –ü–æ–ª–∏—Ç–∏ —Å–æ—É—Å–æ–º, –ø–æ—Å–∏–ø–∞—Ç–∏ –ø–∞—Ä–º–µ–∑–∞–Ω–æ–º.',
  },
  {
    name: '–ì—Ä–µ—á–∫–∞ –∑ –≥—Ä–∏–±–∞–º–∏',
    time: '25 —Ö–≤',
    calories: 290,
    protein: 12,
    requiredProducts: ['–≥—Ä–µ—á–∫', '–≥—Ä–∏–±'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞', '–≤–µ–≥–∞–Ω'],
    ingredients: [
      '–ì—Ä–µ—á–∫–∞ - 150–≥',
      '–®–∞–º–ø—ñ–Ω—å–π–æ–Ω–∏ - 150–≥',
      '–¶–∏–±—É–ª—è - 1—à—Ç',
      '–ú–æ—Ä–∫–≤–∞ - 1—à—Ç',
      '–û–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è - 1 —Å—Ç.–ª.',
    ],
    instructions: '–í—ñ–¥–≤–∞—Ä–∏—Ç–∏ –≥—Ä–µ—á–∫—É. –û–±—Å–º–∞–∂–∏—Ç–∏ –Ω–∞—Ä—ñ–∑–∞–Ω—ñ –≥—Ä–∏–±–∏ –∑ —Ü–∏–±—É–ª–µ—é —Ç–∞ –º–æ—Ä–∫–≤–æ—é. –ó–º—ñ—à–∞—Ç–∏ –∑ –≥—Ä–µ—á–∫–æ—é.',
  },
  {
    name: '–†–∏—Å –∑ –∫—Ä–µ–≤–µ—Ç–∫–∞–º–∏',
    time: '25 —Ö–≤',
    calories: 340,
    protein: 28,
    requiredProducts: ['—Ä–∏—Å', '–∫—Ä–µ–≤–µ—Ç–∫'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É'],
    ingredients: [
      '–†–∏—Å –±–∞—Å–º–∞—Ç—ñ - 150–≥',
      '–ö—Ä–µ–≤–µ—Ç–∫–∏ - 200–≥',
      '–ß–∞—Å–Ω–∏–∫ - 2 –∑—É–±—á–∏–∫–∏',
      '–õ–∏–º–æ–Ω - 0.5—à—Ç',
      '–ú–∞—Å–ª–æ –≤–µ—Ä—à–∫–æ–≤–µ - 20–≥',
    ],
    instructions: '–í—ñ–¥–≤–∞—Ä–∏—Ç–∏ —Ä–∏—Å. –û–±—Å–º–∞–∂–∏—Ç–∏ –∫—Ä–µ–≤–µ—Ç–∫–∏ –∑ —á–∞—Å–Ω–∏–∫–æ–º –Ω–∞ –≤–µ—Ä—à–∫–æ–≤–æ–º—É –º–∞—Å–ª—ñ 3-4 —Ö–≤. –ü–æ–¥–∞–≤–∞—Ç–∏ —Ä–∞–∑–æ–º, –ø–æ–ª–∏—Ç–∏ –ª–∏–º–æ–Ω–Ω–∏–º —Å–æ–∫–æ–º.',
  },
  {
    name: '–ü–∞—Å—Ç–∞ –∑ —Ç–æ–º–∞—Ç–Ω–∏–º —Å–æ—É—Å–æ–º',
    time: '20 —Ö–≤',
    calories: 380,
    protein: 14,
    requiredProducts: ['–ø–∞—Å—Ç–∞', '–ø–æ–º—ñ–¥–æ—Ä'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞', '–≤–µ–≥–∞–Ω'],
    ingredients: [
      '–ü–∞—Å—Ç–∞ - 200–≥',
      '–ü–æ–º—ñ–¥–æ—Ä–∏ - 3—à—Ç',
      '–ß–∞—Å–Ω–∏–∫ - 2 –∑—É–±—á–∏–∫–∏',
      '–ë–∞–∑–∏–ª—ñ–∫ - –ø—É—á–æ–∫',
      '–û–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è - 2 —Å—Ç.–ª.',
      '–ü–∞—Ä–º–µ–∑–∞–Ω - 20–≥',
    ],
    instructions: '–í—ñ–¥–≤–∞—Ä–∏—Ç–∏ –ø–∞—Å—Ç—É. –ü–æ–º—ñ–¥–æ—Ä–∏ –æ–±–¥–∞—Ç–∏ –æ–∫—Ä–æ–ø–æ–º, –∑–Ω—è—Ç–∏ —à–∫—ñ—Ä–∫—É, –ø–æ–¥—Ä—ñ–±–Ω–∏—Ç–∏. –û–±—Å–º–∞–∂–∏—Ç–∏ —á–∞—Å–Ω–∏–∫, –¥–æ–¥–∞—Ç–∏ –ø–æ–º—ñ–¥–æ—Ä–∏, —Ç—É—à–∫—É–≤–∞—Ç–∏ 10 —Ö–≤. –î–æ–¥–∞—Ç–∏ –±–∞–∑–∏–ª—ñ–∫. –ü–æ–¥–∞–≤–∞—Ç–∏ –∑ –ø–∞—Ä–º–µ–∑–∞–Ω–æ–º.',
  },
  {
    name: '–û–≤–æ—á–µ–≤–∏–π —Å—É–ø',
    time: '35 —Ö–≤',
    calories: 180,
    protein: 8,
    requiredProducts: ['–∫–∞—Ä—Ç–æ–ø–ª', '–º–æ—Ä–∫–æ–≤', '—Ü–∏–±—É–ª'],
    tags: ['–æ–±—ñ–¥', '–ª–µ–≥–∫', '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞', '–≤–µ–≥–∞–Ω', '—Å—É–ø'],
    ingredients: [
      '–ö–∞—Ä—Ç–æ–ø–ª—è - 2—à—Ç',
      '–ú–æ—Ä–∫–≤–∞ - 1—à—Ç',
      '–¶–∏–±—É–ª—è - 1—à—Ç',
      '–°–µ–ª–µ—Ä–∞ - 1 —Å—Ç–µ–±–ª–æ',
      '–ó–µ–ª–µ–Ω—å - –∑–∞ —Å–º–∞–∫–æ–º',
      '–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å',
    ],
    instructions: '–ù–∞—Ä—ñ–∑–∞—Ç–∏ –≤—Å—ñ –æ–≤–æ—á—ñ –∫—É–±–∏–∫–∞–º–∏. –í–∞—Ä–∏—Ç–∏ –≤ –ø—ñ–¥—Å–æ–ª–µ–Ω—ñ–π –≤–æ–¥—ñ 25-30 —Ö–≤ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ. –ü–æ–¥–∞–≤–∞—Ç–∏ —ñ–∑ –∑–µ–ª–µ–Ω–Ω—é.',
  },
  {
    name: '–¢–≤–æ—Ä–æ–∂–Ω—ñ –ø–∞–Ω–∫–µ–π–∫–∏',
    time: '20 —Ö–≤',
    calories: 300,
    protein: 24,
    requiredProducts: ['—Ç–≤–æ—Ä–æ–≥', '—è–π—Ü', '–±–æ—Ä–æ—à–Ω–æ'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '—Å–æ–ª–æ–¥–∫', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É'],
    ingredients: [
      '–¢–≤–æ—Ä–æ–≥ 5% - 200–≥',
      '–Ø–π—Ü–µ - 1—à—Ç',
      '–ë–æ—Ä–æ—à–Ω–æ - 2 —Å—Ç.–ª.',
      '–ë–∞–Ω–∞–Ω - 0.5—à—Ç',
      '–ú–µ–¥ - 1 —á.–ª.',
    ],
    instructions: '–ó–º—ñ—à–∞—Ç–∏ —Ç–≤–æ—Ä–æ–≥, —è–π—Ü–µ, –±–æ—Ä–æ—à–Ω–æ —Ç–∞ –ø—é—Ä–µ –∑ –±–∞–Ω–∞–Ω–∞. –°–º–∞–∂–∏—Ç–∏ –Ω–∞ –∞–Ω—Ç–∏–ø—Ä–∏–≥–∞—Ä–Ω—ñ–π —Å–∫–æ–≤–æ—Ä–æ–¥—ñ –∑ –æ–±–æ—Ö —Å—Ç–æ—Ä—ñ–Ω –¥–æ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ–≥–æ –∫–æ–ª—å–æ—Ä—É.',
  },
  {
    name: '–ó–∞–ø–µ—á–µ–Ω–∞ —Ä–∏–±–∞ –∑ –ª–∏–º–æ–Ω–æ–º',
    time: '30 —Ö–≤',
    calories: 260,
    protein: 32,
    requiredProducts: ['—Ä–∏–±', '–ª–∏–º–æ–Ω'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±—ñ–ª–æ–∫', '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞'],
    ingredients: [
      '–§—ñ–ª–µ —Ä–∏–±–∏ - 200–≥',
      '–õ–∏–º–æ–Ω - 1—à—Ç',
      '–ß–∞—Å–Ω–∏–∫ - 2 –∑—É–±—á–∏–∫–∏',
      '–†–æ–∑–º–∞—Ä–∏–Ω - –≥—ñ–ª–æ—á–∫–∞',
      '–û–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è - 1 —Å—Ç.–ª.',
    ],
    instructions: '–§—ñ–ª–µ –∑–∞–º–∞—Ä–∏–Ω—É–≤–∞—Ç–∏ –∑ –ª–∏–º–æ–Ω–Ω–∏–º —Å–æ–∫–æ–º, —á–∞—Å–Ω–∏–∫–æ–º —Ç–∞ —Ä–æ–∑–º–∞—Ä–∏–Ω–æ–º –Ω–∞ 10 —Ö–≤. –ó–∞–ø—ñ–∫–∞—Ç–∏ –≤ –¥—É—Ö–æ–≤—Ü—ñ –ø—Ä–∏ 200¬∞–° 15-20 —Ö–≤.',
  },
  {
    name: '–û–≤—Å—è–Ω–∫–∞ –∑ —è–≥–æ–¥–∞–º–∏ —Ç–∞ –≥–æ—Ä—ñ—Ö–∞–º–∏',
    time: '10 —Ö–≤',
    calories: 310,
    protein: 10,
    requiredProducts: ['–≤—ñ–≤—Å—è–Ω', '–º–æ–ª–æ–∫–æ'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '—Å–æ–ª–æ–¥–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '—à–≤–∏–¥–∫'],
    ingredients: [
      '–í—ñ–≤—Å—è–Ω—ñ –ø–ª–∞—Å—Ç—ñ–≤—Ü—ñ - 80–≥',
      '–ú–æ–ª–æ–∫–æ - 200–º–ª',
      '–Ø–≥–æ–¥–∏ (–±—É–¥—å-—è–∫—ñ) - 80–≥',
      '–ì–æ—Ä—ñ—Ö–∏ - 20–≥',
      '–ú–µ–¥ - 1 —á.–ª.',
    ],
    instructions: '–ó–≤–∞—Ä–∏—Ç–∏ –≤—ñ–≤—Å—è–Ω–∫—É –Ω–∞ –º–æ–ª–æ—Ü—ñ. –î–æ–¥–∞—Ç–∏ —è–≥–æ–¥–∏, –≥–æ—Ä—ñ—Ö–∏ —Ç–∞ –º–µ–¥.',
  },
  {
    name: '–ö—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞ –∑ —Ä–∏—Å–æ–º —ñ –±—Ä–æ–∫–∫–æ–ª—ñ',
    time: '30 —Ö–≤',
    calories: 370,
    protein: 38,
    requiredProducts: ['–∫—É—Ä–∫–∞', '—Ä–∏—Å', '–±—Ä–æ–∫–∫–æ–ª—ñ'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞'],
    ingredients: [
      '–ö—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞ - 200–≥',
      '–†–∏—Å - 150–≥',
      '–ë—Ä–æ–∫–∫–æ–ª—ñ - 150–≥',
      '–°–æ—î–≤–∏–π —Å–æ—É—Å - 2 —Å—Ç.–ª.',
      '–ö—É–Ω–∂—É—Ç - 1 —á.–ª.',
    ],
    instructions: '–í—ñ–¥–≤–∞—Ä–∏—Ç–∏ —Ä–∏—Å —ñ –±—Ä–æ–∫–∫–æ–ª—ñ. –ö—É—Ä–∫—É –Ω–∞—Ä—ñ–∑–∞—Ç–∏, –æ–±—Å–º–∞–∂–∏—Ç–∏ –∑ —Å–æ—î–≤–∏–º —Å–æ—É—Å–æ–º. –ü–æ–¥–∞–≤–∞—Ç–∏ —Ä–∞–∑–æ–º, –ø–æ—Å–∏–ø–∞—Ç–∏ –∫—É–Ω–∂—É—Ç–æ–º.',
  },
  {
    name: '–¢–æ—Å—Ç –∑ –∞–≤–æ–∫–∞–¥–æ —Ç–∞ —è–π—Ü–µ–º',
    time: '10 —Ö–≤',
    calories: 290,
    protein: 14,
    requiredProducts: ['–∞–≤–æ–∫–∞–¥–æ', '—Ö–ª—ñ–±', '—è–π—Ü'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '—à–≤–∏–¥–∫', '–±–µ–∑ –º–æ–ª–æ–∫–∞'],
    ingredients: [
      '–•–ª—ñ–± —Ü—ñ–ª—å–Ω–æ–∑–µ—Ä–Ω–æ–≤–∏–π - 2 —Å–∫–∏–±–∫–∏',
      '–ê–≤–æ–∫–∞–¥–æ - 0.5—à—Ç',
      '–Ø–π—Ü–µ - 1—à—Ç',
      '–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å, –ª–∏–º–æ–Ω–Ω–∏–π —Å—ñ–∫',
    ],
    instructions: '–ü—ñ–¥—Å–º–∞–∂–∏—Ç–∏ —Ö–ª—ñ–±. –†–æ–∑—ñ–º\'—è—Ç–∏ –∞–≤–æ–∫–∞–¥–æ –∑ –ª–∏–º–æ–Ω–Ω–∏–º —Å–æ–∫–æ–º, –Ω–∞–º–∞–∑–∞—Ç–∏ –Ω–∞ —Ç–æ—Å—Ç. –ó–≤–µ—Ä—Ö—É –ø–æ–∫–ª–∞—Å—Ç–∏ —è–π—Ü–µ –ø–∞—à–æ—Ç –∞–±–æ –≤–∞—Ä–µ–Ω–µ.',
  },
  {
    name: '–Ü–Ω–¥–∏—á–∫–∞ –∑ –æ–≤–æ—á–∞–º–∏ –≤ –¥—É—Ö–æ–≤—Ü—ñ',
    time: '45 —Ö–≤',
    calories: 310,
    protein: 36,
    requiredProducts: ['—ñ–Ω–¥–∏—á–∫', '–∫–∞–±–∞—á–æ–∫', '–±–∞–∫–ª–∞–∂–∞–Ω'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞'],
    ingredients: [
      '–§—ñ–ª–µ —ñ–Ω–¥–∏—á–∫–∏ - 200–≥',
      '–ö–∞–±–∞—á–æ–∫ - 1—à—Ç',
      '–ë–∞–∫–ª–∞–∂–∞–Ω - 1—à—Ç',
      '–ü–æ–º—ñ–¥–æ—Ä–∏ —á–µ—Ä—Ä—ñ - 100–≥',
      '–û–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è - 1 —Å—Ç.–ª.',
      '–ü—Ä–æ–≤–∞–Ω—Å—å–∫—ñ —Ç—Ä–∞–≤–∏',
    ],
    instructions: '–ù–∞—Ä—ñ–∑–∞—Ç–∏ —ñ–Ω–¥–∏—á–∫—É —Ç–∞ –æ–≤–æ—á—ñ. –í–∏–∫–ª–∞—Å—Ç–∏ –Ω–∞ –¥–µ–∫–æ, –ø–æ–ª–∏—Ç–∏ –æ–ª—ñ—î—é, –¥–æ–¥–∞—Ç–∏ —Å–ø–µ—Ü—ñ—ó. –ó–∞–ø—ñ–∫–∞—Ç–∏ –ø—Ä–∏ 190¬∞–° 30-35 —Ö–≤.',
  },
  {
    name: '–ö–∞—Ä—Ç–æ–ø–ª—è –∑ –º\'—è—Å–æ–º –ø–æ-–¥–æ–º–∞—à–Ω—å–æ–º—É',
    time: '40 —Ö–≤',
    calories: 420,
    protein: 25,
    requiredProducts: ['–∫–∞—Ä—Ç–æ–ø–ª', '–º\'—è—Å', '—Ü–∏–±—É–ª'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '—Å–∏—Ç–Ω', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞'],
    ingredients: [
      '–ö–∞—Ä—Ç–æ–ø–ª—è - 300–≥',
      '–ú\'—è—Å–æ (—Å–≤–∏–Ω–∏–Ω–∞ –∞–±–æ —è–ª–æ–≤–∏—á–∏–Ω–∞) - 200–≥',
      '–¶–∏–±—É–ª—è - 1—à—Ç',
      '–ß–∞—Å–Ω–∏–∫ - 2 –∑—É–±—á–∏–∫–∏',
      '–û–ª—ñ—è - 2 —Å—Ç.–ª.',
      '–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å, –ª–∞–≤—Ä–æ–≤–∏–π –ª–∏—Å—Ç',
    ],
    instructions: '–û–±—Å–º–∞–∂–∏—Ç–∏ –º\'—è—Å–æ –∑ —Ü–∏–±—É–ª–µ—é. –î–æ–¥–∞—Ç–∏ –Ω–∞—Ä—ñ–∑–∞–Ω—É –∫–∞—Ä—Ç–æ–ø–ª—é, –∑–∞–ª–∏—Ç–∏ –≤–æ–¥–æ—é, –¥–æ–¥–∞—Ç–∏ —Å–ø–µ—Ü—ñ—ó. –¢—É—à–∫—É–≤–∞—Ç–∏ –ø—ñ–¥ –∫—Ä–∏—à–∫–æ—é 25-30 —Ö–≤.',
  },
  {
    name: '–Ø—î—á–Ω—è –∑ –∫–æ–≤–±–∞—Å–æ—é',
    time: '10 —Ö–≤',
    calories: 330,
    protein: 20,
    requiredProducts: ['—è–π—Ü', '–∫–æ–≤–±–∞—Å'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '—à–≤–∏–¥–∫'],
    ingredients: [
      '–Ø–π—Ü—è - 3—à—Ç',
      '–ö–æ–≤–±–∞—Å–∞ –≤–∞—Ä–µ–Ω–∞ - 80–≥',
      '–ú–∞—Å–ª–æ –≤–µ—Ä—à–∫–æ–≤–µ - 10–≥',
      '–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å',
    ],
    instructions: '–ù–∞—Ä—ñ–∑–∞—Ç–∏ –∫–æ–≤–±–∞—Å—É, –æ–±—Å–º–∞–∂–∏—Ç–∏ –Ω–∞ –º–∞—Å–ª—ñ. –ó–∞–ª–∏—Ç–∏ —è–π—Ü—è–º–∏, —Å–º–∞–∂–∏—Ç–∏ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ.',
  },
  {
    name: '–ö—É—Ä—è—á–∏–π —Å—É–ø –∑ –ª–æ–∫—à–∏–Ω–æ—é',
    time: '40 —Ö–≤',
    calories: 250,
    protein: 22,
    requiredProducts: ['–∫—É—Ä–∫–∞', '–ª–æ–∫—à–∏–Ω', '–∫–∞—Ä—Ç–æ–ø–ª'],
    tags: ['–æ–±—ñ–¥', '—Å—É–ø', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É'],
    ingredients: [
      '–ö—É—Ä—è—á–µ —Ñ—ñ–ª–µ - 200–≥',
      '–õ–æ–∫—à–∏–Ω–∞ - 80–≥',
      '–ö–∞—Ä—Ç–æ–ø–ª—è - 2—à—Ç',
      '–ú–æ—Ä–∫–≤–∞ - 1—à—Ç',
      '–¶–∏–±—É–ª—è - 1—à—Ç',
      '–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å, –∑–µ–ª–µ–Ω—å',
    ],
    instructions: '–ó–≤–∞—Ä–∏—Ç–∏ –∫—É—Ä–∫—É, –¥—ñ—Å—Ç–∞—Ç–∏, –Ω–∞—Ä—ñ–∑–∞—Ç–∏. –£ –±—É–ª—å–π–æ–Ω –¥–æ–¥–∞—Ç–∏ –∫–∞—Ä—Ç–æ–ø–ª—é, –≤–∞—Ä–∏—Ç–∏ 10 —Ö–≤. –î–æ–¥–∞—Ç–∏ –ª–æ–∫—à–∏–Ω—É, –º–æ—Ä–∫–≤—É, —Ü–∏–±—É–ª—é, –≤–∞—Ä–∏—Ç–∏ —â–µ 7 —Ö–≤. –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –∫—É—Ä–∫—É.',
  },
  {
    name: '–ë–∞–Ω–∞–Ω–æ–≤–∏–π —Å–º—É–∑—ñ',
    time: '5 —Ö–≤',
    calories: 200,
    protein: 8,
    requiredProducts: ['–±–∞–Ω–∞–Ω', '–º–æ–ª–æ–∫–æ'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '–ø–µ—Ä–µ–∫—É—Å', '—Å–æ–ª–æ–¥–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '—à–≤–∏–¥–∫'],
    ingredients: [
      '–ë–∞–Ω–∞–Ω - 2—à—Ç',
      '–ú–æ–ª–æ–∫–æ - 250–º–ª',
      '–ú–µ–¥ - 1 —á.–ª.',
    ],
    instructions: '–ó–±–∏—Ç–∏ –±–∞–Ω–∞–Ω–∏ –∑ –º–æ–ª–æ–∫–æ–º —É –±–ª–µ–Ω–¥–µ—Ä—ñ –¥–æ –æ–¥–Ω–æ—Ä—ñ–¥–Ω–æ—ó –º–∞—Å–∏. –î–æ–¥–∞—Ç–∏ –º–µ–¥ –∑–∞ –±–∞–∂–∞–Ω–Ω—è–º.',
  },
  {
    name: '–†–∏—Å –∑ –∫—É—Ä–∫–æ—é –ø–æ-–∞–∑—ñ–∞—Ç—Å—å–∫–∏',
    time: '25 —Ö–≤',
    calories: 380,
    protein: 32,
    requiredProducts: ['—Ä–∏—Å', '–∫—É—Ä–∫–∞'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞'],
    ingredients: [
      '–†–∏—Å - 150–≥',
      '–ö—É—Ä—è—á–µ —Ñ—ñ–ª–µ - 200–≥',
      '–°–æ—î–≤–∏–π —Å–æ—É—Å - 2 —Å—Ç.–ª.',
      '–ß–∞—Å–Ω–∏–∫ - 2 –∑—É–±—á–∏–∫–∏',
      '–û–ª—ñ—è - 1 —Å—Ç.–ª.',
    ],
    instructions: '–í—ñ–¥–≤–∞—Ä–∏—Ç–∏ —Ä–∏—Å. –ö—É—Ä–∫—É –Ω–∞—Ä—ñ–∑–∞—Ç–∏, –æ–±—Å–º–∞–∂–∏—Ç–∏ –Ω–∞ –æ–ª—ñ—ó –∑ —á–∞—Å–Ω–∏–∫–æ–º. –î–æ–¥–∞—Ç–∏ —Å–æ—î–≤–∏–π —Å–æ—É—Å, –ø–µ—Ä–µ–º—ñ—à–∞—Ç–∏ –∑ —Ä–∏—Å–æ–º.',
  },
  {
    name: '–°–∏—Ä–Ω–∏–∫–∏',
    time: '20 —Ö–≤',
    calories: 280,
    protein: 20,
    requiredProducts: ['—Ç–≤–æ—Ä–æ–≥', '—è–π—Ü'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '—Å–æ–ª–æ–¥–∫', '–±—ñ–ª–æ–∫'],
    ingredients: [
      '–¢–≤–æ—Ä–æ–≥ - 300–≥',
      '–Ø–π—Ü–µ - 1—à—Ç',
      '–¶—É–∫–æ—Ä - 2 —Å—Ç.–ª.',
      '–ë–æ—Ä–æ—à–Ω–æ - 3 —Å—Ç.–ª.',
      '–û–ª—ñ—è –¥–ª—è —Å–º–∞–∂–µ–Ω–Ω—è',
    ],
    instructions: '–ó–º—ñ—à–∞—Ç–∏ —Ç–≤–æ—Ä–æ–≥, —è–π—Ü–µ, —Ü—É–∫–æ—Ä —Ç–∞ –±–æ—Ä–æ—à–Ω–æ. –°—Ñ–æ—Ä–º—É–≤–∞—Ç–∏ —Å–∏—Ä–Ω–∏–∫–∏, –æ–±–≤–∞–ª—è—Ç–∏ –≤ –±–æ—Ä–æ—à–Ω—ñ. –°–º–∞–∂–∏—Ç–∏ –∑ –æ–±–æ—Ö —Å—Ç–æ—Ä—ñ–Ω –¥–æ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ—ó —Å–∫–æ—Ä–∏–Ω–∫–∏.',
  },
  {
    name: '–ì—Ä–µ—á–∫–∞ –∑ –∫—É—Ä–∫–æ—é',
    time: '30 —Ö–≤',
    calories: 350,
    protein: 35,
    requiredProducts: ['–≥—Ä–µ—á–∫', '–∫—É—Ä–∫–∞'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '–±—ñ–ª–æ–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞'],
    ingredients: [
      '–ì—Ä–µ—á–∫–∞ - 150–≥',
      '–ö—É—Ä—è—á–µ —Ñ—ñ–ª–µ - 200–≥',
      '–¶–∏–±—É–ª—è - 1—à—Ç',
      '–ú–æ—Ä–∫–≤–∞ - 1—à—Ç',
      '–û–ª—ñ—è - 1 —Å—Ç.–ª.',
      '–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å',
    ],
    instructions: '–í—ñ–¥–≤–∞—Ä–∏—Ç–∏ –≥—Ä–µ—á–∫—É. –ö—É—Ä–∫—É –Ω–∞—Ä—ñ–∑–∞—Ç–∏, –æ–±—Å–º–∞–∂–∏—Ç–∏ –∑ —Ü–∏–±—É–ª–µ—é —Ç–∞ –º–æ—Ä–∫–≤–æ—é. –ü–æ–¥–∞–≤–∞—Ç–∏ —Ä–∞–∑–æ–º.',
  },
  {
    name: '–ú–∞–∫–∞—Ä–æ–Ω–∏ –∑ —Å–∏—Ä–æ–º',
    time: '15 —Ö–≤',
    calories: 400,
    protein: 16,
    requiredProducts: ['–º–∞–∫–∞—Ä–æ–Ω', '—Å–∏—Ä'],
    tags: ['–æ–±—ñ–¥', '–≤–µ—á–µ—Ä—è', '—à–≤–∏–¥–∫', '–±–µ–∑ —Ü—É–∫—Ä—É', '—Å–∏—Ç–Ω'],
    ingredients: [
      '–ú–∞–∫–∞—Ä–æ–Ω–∏ - 200–≥',
      '–°–∏—Ä —Ç–≤–µ—Ä–¥–∏–π - 100–≥',
      '–ú–∞—Å–ª–æ –≤–µ—Ä—à–∫–æ–≤–µ - 20–≥',
      '–°—ñ–ª—å',
    ],
    instructions: '–í—ñ–¥–≤–∞—Ä–∏—Ç–∏ –º–∞–∫–∞—Ä–æ–Ω–∏. –î–æ–¥–∞—Ç–∏ –≤–µ—Ä—à–∫–æ–≤–µ –º–∞—Å–ª–æ —Ç–∞ —Ç–µ—Ä—Ç–∏–π —Å–∏—Ä, –ø–µ—Ä–µ–º—ñ—à–∞—Ç–∏ –¥–æ —Ä–æ–∑–ø–ª–∞–≤–ª–µ–Ω–Ω—è —Å–∏—Ä—É.',
  },
  {
    name: '–Ø–π—Ü—è –≤–∞—Ä–µ–Ω—ñ –∑ –æ–≤–æ—á–∞–º–∏',
    time: '15 —Ö–≤',
    calories: 220,
    protein: 16,
    requiredProducts: ['—è–π—Ü', '–ø–æ–º—ñ–¥–æ—Ä', '–æ–≥—ñ—Ä–æ–∫'],
    tags: ['—Å–Ω—ñ–¥–∞–Ω–æ–∫', '–±—ñ–ª–æ–∫', '–ª–µ–≥–∫', '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω', '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É', '–±–µ–∑ –º–æ–ª–æ–∫–∞', '—à–≤–∏–¥–∫'],
    ingredients: [
      '–Ø–π—Ü—è - 3—à—Ç',
      '–ü–æ–º—ñ–¥–æ—Ä - 1—à—Ç',
      '–û–≥—ñ—Ä–æ–∫ - 1—à—Ç',
      '–û–ª—ñ—è –æ–ª–∏–≤–∫–æ–≤–∞ - 1 —á.–ª.',
      '–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å',
    ],
    instructions: '–ó–≤–∞—Ä–∏—Ç–∏ —è–π—Ü—è –≤–∫—Ä—É—Ç—É (10 —Ö–≤). –ù–∞—Ä—ñ–∑–∞—Ç–∏ –æ–≤–æ—á—ñ. –ü–æ–¥–∞–≤–∞—Ç–∏ —Ä–∞–∑–æ–º —è–∫ –ª–µ–≥–∫–∏–π —Å–Ω—ñ–¥–∞–Ω–æ–∫.',
  },
];

// Synonym map: user may type these words, which mean the same product
const SYNONYMS = {
  '–∫—É—Ä—è—á': '–∫—É—Ä–∫–∞', '–∫—É—Ä—è—Ç': '–∫—É—Ä–∫–∞', '–∫—É—Ä–∏—á': '–∫—É—Ä–∫–∞', '—Ñ–∏–ª–µ –∫—É—Ä–∫': '–∫—É—Ä–∫–∞', '–≥—Ä—É–¥–∫': '–∫—É—Ä–∫–∞',
  '—è—î—Ü': '—è–π—Ü', '—è–π–∫': '—è–π—Ü', '—è—î—á–Ω': '—è–π—Ü',
  '–ø–æ–º—ñ–¥–æ—Ä': '–ø–æ–º—ñ–¥–æ—Ä', '—Ç–æ–º–∞—Ç': '–ø–æ–º—ñ–¥–æ—Ä',
  '—à–∞–º–ø—ñ–Ω—å–π–æ–Ω': '–≥—Ä–∏–±', '–≥—Ä–∏–±–∏': '–≥—Ä–∏–±',
  '—Å–ø–∞–≥–µ—Ç—ñ': '–ø–∞—Å—Ç–∞', '–º–∞–∫–∞—Ä–æ–Ω': '–º–∞–∫–∞—Ä–æ–Ω', '–ø–∞—Å—Ç—É': '–ø–∞—Å—Ç–∞', '–ø–∞—Å—Ç': '–ø–∞—Å—Ç–∞',
  '–ª–æ—Å–æ—Å—å': '—Ä–∏–±', '—Å—å–æ–º–≥–∞': '—Ä–∏–±', '—Ñ–æ—Ä–µ–ª—å': '—Ä–∏–±', '—Ç–∏–ª–∞–ø—ñ—è': '—Ä–∏–±', '—Ñ—ñ–ª–µ —Ä–∏–±': '—Ä–∏–±',
  '–≤—ñ–≤—Å—è–Ω': '–≤—ñ–≤—Å—è–Ω', '–æ–≤—Å—è–Ω': '–≤—ñ–≤—Å—è–Ω', '–≥–µ—Ä–∫—É–ª–µ—Å': '–≤—ñ–≤—Å—è–Ω',
  '—ñ–Ω–¥–∏–∫': '—ñ–Ω–¥–∏—á–∫', '—ñ–Ω–¥–µ–π–∫': '—ñ–Ω–¥–∏—á–∫',
  '—Å–≤–∏–Ω–∏–Ω': "–º'—è—Å", '—è–ª–æ–≤–∏—á–∏–Ω': "–º'—è—Å", '—Ç–µ–ª—è—Ç–∏–Ω': "–º'—è—Å", '–º—è—Å–æ': "–º'—è—Å",
  '–∫–∞—Ä—Ç–æ—à–∫': '–∫–∞—Ä—Ç–æ–ø–ª', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª': '–∫–∞—Ä—Ç–æ–ø–ª',
  '–ª—É–∫': '—Ü–∏–±—É–ª', '—Ü–∏–±—É–ª—é': '—Ü–∏–±—É–ª', '—Ü—ã–±—É–ª': '—Ü–∏–±—É–ª',
  '–º–æ—Ä–∫–≤–∏–Ω': '–º–æ—Ä–∫–æ–≤', '–º–æ—Ä–∫–æ–≤–∫': '–º–æ—Ä–∫–æ–≤',
  '–ª–æ–∫—à–∏–Ω': '–ª–æ–∫—à–∏–Ω', '–≤–µ—Ä–º—ñ—à–µ–ª': '–ª–æ–∫—à–∏–Ω', '–ª–∞–ø—à': '–ª–æ–∫—à–∏–Ω',
  '–≥—Ä–µ—á–∞–Ω': '–≥—Ä–µ—á–∫',
  '—Å–æ—Å–∏—Å–∫': '–∫–æ–≤–±–∞—Å',
};

// Normalize text for matching
const normalizeText = (text) => {
  return text.toLowerCase()
    .replace(/[—ñ—ó]/g, '—ñ')
    .replace(/[' º`]/g, "'")
    .trim();
};

// Multi-word product names mapped to their canonical form
const COMPOUND_PRODUCTS = {
  '–ø–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞': '–ø–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–ø–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç—É': '–ø–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–ø–µ–∫—ñ–Ω—Å—å–∫–æ—ñ –∫–∞–ø—É—Å—Ç–∏': '–ø–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '—Ü–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç–∞': '—Ü–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç–∞',
  '—Ü–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç—É': '—Ü–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç–∞',
  '—Ü–≤—ñ—Ç–Ω–æ—ñ –∫–∞–ø—É—Å—Ç–∏': '—Ü–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–±—Ä—é—Å—Å–µ–ª—å—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞': '–±—Ä—é—Å—Å–µ–ª—å—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–±—Ä—é—Å—Å–µ–ª—å—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç—É': '–±—Ä—é—Å—Å–µ–ª—å—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–±—Ä—é—Å—Å–µ–ª—å—Å—å–∫–æ—ñ –∫–∞–ø—É—Å—Ç–∏': '–±—Ä—é—Å—Å–µ–ª—å—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–º–æ—Ä—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞': '–º–æ—Ä—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–º–æ—Ä—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç—É': '–º–æ—Ä—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–º–æ—Ä—Å—å–∫–æ—ñ –∫–∞–ø—É—Å—Ç–∏': '–º–æ—Ä—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–±—ñ–ª–æ–∫–∞—á–∞–Ω–Ω–∞ –∫–∞–ø—É—Å—Ç–∞': '–±—ñ–ª–æ–∫–∞—á–∞–Ω–Ω–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–±—ñ–ª–æ–∫–∞—á–∞–Ω–Ω–∞ –∫–∞–ø—É—Å—Ç—É': '–±—ñ–ª–æ–∫–∞—á–∞–Ω–Ω–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–±–æ–ª–≥–∞—Ä—Å—å–∫–∏–π –ø–µ—Ä–µ—Ü—å': '–±–æ–ª–≥–∞—Ä—Å—å–∫–∏–π –ø–µ—Ä–µ—Ü—å',
  '–±–æ–ª–≥–∞—Ä—Å—å–∫–æ–≥–æ –ø–µ—Ä—Ü—é': '–±–æ–ª–≥–∞—Ä—Å—å–∫–∏–π –ø–µ—Ä–µ—Ü—å',
  '—á–∏–ª—ñ –ø–µ—Ä–µ—Ü—å': '–ø–µ—Ä–µ—Ü—å —á–∏–ª—ñ',
  '–ø–µ—Ä–µ—Ü—å —á–∏–ª—ñ': '–ø–µ—Ä–µ—Ü—å —á–∏–ª—ñ',
  '—Å–æ—î–≤–∏–π —Å–æ—É—Å': '—Å–æ—î–≤–∏–π —Å–æ—É—Å',
  '—Å–æ—î–≤–æ–≥–æ —Å–æ—É—Å—É': '—Å–æ—î–≤–∏–π —Å–æ—É—Å',
  '–≤–µ—Ä—à–∫–æ–≤–µ –º–∞—Å–ª–æ': '–≤–µ—Ä—à–∫–æ–≤–µ –º–∞—Å–ª–æ',
  '–≤–µ—Ä—à–∫–æ–≤–æ–≥–æ –º–∞—Å–ª–∞': '–≤–µ—Ä—à–∫–æ–≤–µ –º–∞—Å–ª–æ',
  '–æ–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è': '–æ–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è',
  '–æ–ª–∏–≤–∫–æ–≤–æ—ñ –æ–ª—ñ—ñ': '–æ–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è',
  '–æ–ª–∏–≤–∫–æ–≤—É –æ–ª—ñ—é': '–æ–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è',
  '–≥—Ä–µ—Ü—å–∫–∏–π –≥–æ—Ä—ñ—Ö': '–≥—Ä–µ—Ü—å–∫—ñ –≥–æ—Ä—ñ—Ö–∏',
  '–≥—Ä–µ—Ü—å–∫—ñ –≥–æ—Ä—ñ—Ö–∏': '–≥—Ä–µ—Ü—å–∫—ñ –≥–æ—Ä—ñ—Ö–∏',
  '–≥—Ä–µ—Ü—å–∫–∏—Ö –≥–æ—Ä—ñ—Ö—ñ–≤': '–≥—Ä–µ—Ü—å–∫—ñ –≥–æ—Ä—ñ—Ö–∏',
  '–∫–µ–¥—Ä–æ–≤–∏–π –≥–æ—Ä—ñ—Ö': '–∫–µ–¥—Ä–æ–≤—ñ –≥–æ—Ä—ñ—Ö–∏',
  '–∫–µ–¥—Ä–æ–≤—ñ –≥–æ—Ä—ñ—Ö–∏': '–∫–µ–¥—Ä–æ–≤—ñ –≥–æ—Ä—ñ—Ö–∏',
  '–∑–µ–ª–µ–Ω–∞ —Ü–∏–±—É–ª—è': '–∑–µ–ª–µ–Ω–∞ —Ü–∏–±—É–ª—è',
  '–∑–µ–ª–µ–Ω–æ—ñ —Ü–∏–±—É–ª—ñ': '–∑–µ–ª–µ–Ω–∞ —Ü–∏–±—É–ª—è',
  '–∫—É—Ä—è—á–µ —Ñ—ñ–ª–µ': '–∫—É—Ä—è—á–µ —Ñ—ñ–ª–µ',
  '–∫—É—Ä—è—á–æ–≥–æ —Ñ—ñ–ª–µ': '–∫—É—Ä—è—á–µ —Ñ—ñ–ª–µ',
  '–∫—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞': '–∫—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞',
  '–∫—É—Ä—è—á–æ—ñ –≥—Ä—É–¥–∫–∏': '–∫—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞',
  '—Å–≤–∏–Ω—è—á–∞ –≤–∏—Ä—ñ–∑–∫–∞': '—Å–≤–∏–Ω—è—á–∞ –≤–∏—Ä—ñ–∑–∫–∞',
  '—Å–≤–∏–Ω—è—á–æ—ñ –≤–∏—Ä—ñ–∑–∫–∏': '—Å–≤–∏–Ω—è—á–∞ –≤–∏—Ä—ñ–∑–∫–∞',
  '—è–ª–æ–≤–∏—á–∞ –≤–∏—Ä—ñ–∑–∫–∞': '—è–ª–æ–≤–∏—á–∞ –≤–∏—Ä—ñ–∑–∫–∞',
  '—Ñ—ñ–ª–µ —Ä–∏–±–∏': '—Ñ—ñ–ª–µ —Ä–∏–±–∏',
  '—Ä–∏–±–Ω–µ —Ñ—ñ–ª–µ': '—Ñ—ñ–ª–µ —Ä–∏–±–∏',
  '—Å–º–µ—Ç–∞–Ω–Ω–∏–π —Å–æ—É—Å': '—Å–º–µ—Ç–∞–Ω–Ω–∏–π —Å–æ—É—Å',
  '—Å–º–µ—Ç–∞–Ω–Ω–æ–≥–æ —Å–æ—É—Å—É': '—Å–º–µ—Ç–∞–Ω–Ω–∏–π —Å–æ—É—Å',
  '—Ç–æ–º–∞—Ç–Ω–∞ –ø–∞—Å—Ç–∞': '—Ç–æ–º–∞—Ç–Ω–∞ –ø–∞—Å—Ç–∞',
  '—Ç–æ–º–∞—Ç–Ω–æ—ñ –ø–∞—Å—Ç–∏': '—Ç–æ–º–∞—Ç–Ω–∞ –ø–∞—Å—Ç–∞',
  '—Ç–æ–º–∞—Ç–Ω—É –ø–∞—Å—Ç—É': '—Ç–æ–º–∞—Ç–Ω–∞ –ø–∞—Å—Ç–∞',
  '–∞—Ä–∞—Ö—ñ—Å–æ–≤–∞ –ø–∞—Å—Ç–∞': '–∞—Ä–∞—Ö—ñ—Å–æ–≤–∞ –ø–∞—Å—Ç–∞',
  '–∞—Ä–∞—Ö—ñ—Å–æ–≤–æ—ñ –ø–∞—Å—Ç–∏': '–∞—Ä–∞—Ö—ñ—Å–æ–≤–∞ –ø–∞—Å—Ç–∞',
  '—Ä–∏—Å–æ–≤–∞ –ª–æ–∫—à–∏–Ω–∞': '—Ä–∏—Å–æ–≤–∞ –ª–æ–∫—à–∏–Ω–∞',
  '—Ä–∏—Å–æ–≤–æ—ñ –ª–æ–∫—à–∏–Ω–∏': '—Ä–∏—Å–æ–≤–∞ –ª–æ–∫—à–∏–Ω–∞',
  '–ø–ª–∞–≤–ª–µ–Ω–∏–π —Å–∏—Ä': '–ø–ª–∞–≤–ª–µ–Ω–∏–π —Å–∏—Ä',
  '–ø–ª–∞–≤–ª–µ–Ω–æ–≥–æ —Å–∏—Ä—É': '–ø–ª–∞–≤–ª–µ–Ω–∏–π —Å–∏—Ä',
  '–ø–ª–∞–≤–ª–µ–Ω–∏–π —Å–∏—Ä–æ–∫': '–ø–ª–∞–≤–ª–µ–Ω–∏–π —Å–∏—Ä',
  '–∫–æ–∑—è—á–∏–π —Å–∏—Ä': '–∫–æ–∑—è—á–∏–π —Å–∏—Ä',
  '–∫–æ–∑—è—á–æ–≥–æ —Å–∏—Ä—É': '–∫–æ–∑—è—á–∏–π —Å–∏—Ä',
  '–≤—ñ–≤—Å—è–Ω—ñ –ø–ª–∞—Å—Ç—ñ–≤—Ü—ñ': '–≤—ñ–≤—Å—è–Ω—ñ –ø–ª–∞—Å—Ç—ñ–≤—Ü—ñ',
  '–≤—ñ–≤—Å—è–Ω–∏—Ö –ø–ª–∞—Å—Ç—ñ–≤—Ü—ñ–≤': '–≤—ñ–≤—Å—è–Ω—ñ –ø–ª–∞—Å—Ç—ñ–≤—Ü—ñ',
  '—Å—Ç—Ä—É—á–∫–æ–≤–∞ –∫–≤–∞—Å–æ–ª—è': '—Å—Ç—Ä—É—á–∫–æ–≤–∞ –∫–≤–∞—Å–æ–ª—è',
  '—Å—Ç—Ä—É—á–∫–æ–≤–æ—ñ –∫–≤–∞—Å–æ–ª—ñ': '—Å—Ç—Ä—É—á–∫–æ–≤–∞ –∫–≤–∞—Å–æ–ª—è',
  '–∫–æ–∫–æ—Å–æ–≤–µ –º–æ–ª–æ–∫–æ': '–∫–æ–∫–æ—Å–æ–≤–µ –º–æ–ª–æ–∫–æ',
  '–∫–æ–∫–æ—Å–æ–≤–æ–≥–æ –º–æ–ª–æ–∫–∞': '–∫–æ–∫–æ—Å–æ–≤–µ –º–æ–ª–æ–∫–æ',
  '–º–∏–≥–¥–∞–ª—å–Ω–µ –º–æ–ª–æ–∫–æ': '–º–∏–≥–¥–∞–ª—å–Ω–µ –º–æ–ª–æ–∫–æ',
  '–º–∏–≥–¥–∞–ª—å–Ω–æ–≥–æ –º–æ–ª–æ–∫–∞': '–º–∏–≥–¥–∞–ª—å–Ω–µ –º–æ–ª–æ–∫–æ',
  '—á–æ—Ä–Ω–∏–π –ø–µ—Ä–µ—Ü—å': '—á–æ—Ä–Ω–∏–π –ø–µ—Ä–µ—Ü—å',
  '—á–æ—Ä–Ω–æ–≥–æ –ø–µ—Ä—Ü—é': '—á–æ—Ä–Ω–∏–π –ø–µ—Ä–µ—Ü—å',
  '–ª–∞–≤—Ä–æ–≤–∏–π –ª–∏—Å—Ç': '–ª–∞–≤—Ä–æ–≤–∏–π –ª–∏—Å—Ç',
  '–ª–∞–≤—Ä–æ–≤–æ–≥–æ –ª–∏—Å—Ç—É': '–ª–∞–≤—Ä–æ–≤–∏–π –ª–∏—Å—Ç',
};

// Words to ignore when splitting (conjunctions, prepositions, articles, verbs, adjectives
// that are NOT food items ‚Äî prevents "—Ö–æ—á—É —Å–æ–ª–æ–¥–∫–∏–π —Å–Ω—ñ–¥–∞–Ω–æ–∫" from treating each word as ingredient)
const STOP_WORDS = new Set([
  // uk conjunctions / prepositions / particles
  '—ñ', '—Ç–∞', '–∑', '—ñ–∑', '–Ω–∞', '–≤', '—É', '–¥–æ', '–¥–ª—è', '–∞–±–æ', '—á–∏', '—â–æ', '—è–∫',
  '–Ω–µ', '–Ω—ñ', '—Ç–∞–∫', '—Ü–µ', '—Ç–æ–π', '—Ü—è', '—Ü—ñ', '—Ü–µ–π', '—Ç–µ', '–æ—Å—å',
  '–¥—É–∂–µ', '—Ç—Ä–æ—Ö–∏', '–º–æ–∂–Ω–∞', '—â–µ', '–≤–∂–µ', '–ø–æ—Ç—Ä—ñ–±–Ω–æ', '—Ç—Ä–µ–±–∞', '—Ç—ñ–ª—å–∫–∏', '–ª–∏—à–µ',
  '–º–µ–Ω—ñ', '–º–æ—ó', '–º–∞—é', '–º–æ—î', '–º—ñ–π', '–º–æ—è',
  // en
  'and', 'the', 'with', 'for', 'but', 'not', 'without',
  // intent/desire verbs (NOT food)
  '—Ö–æ—á—É', '—Ö–æ—á', '—Ö–æ—Ç—ñ–≤', '—Ö–æ—Ç—ñ–ª–∞', '–±–∞–∂–∞—é', '–ø–æ—Ä–∞–¥—å', '–ø–æ—Ä–∞–¥',
  '–∑–∞–ø—Ä–æ–ø–æ–Ω—É–π', '–ø—ñ–¥–∫–∞–∂–∏', '–ø—ñ–¥–∫–∞–∂', '–¥–∞–π', '–¥–∞–≤–∞–π', '–ø—Ä–∏–≥–æ—Ç—É–π',
  '–ø—Ä–∏–≥–æ—Ç—É–≤–∞—Ç–∏', '–∑—Ä–æ–±–∏', '–∑—Ä–æ–±–∏—Ç–∏', '–ø–æ–∫–∞–∂–∏', 'show', 'give', 'make',
  'want', 'suggest', 'recommend',
  // meal types (handled by intent parser, not products)
  '—Å–Ω—ñ–¥–∞–Ω–æ–∫', '—Å–Ω—ñ–¥–∞–Ω–∫—É', '–æ–±—ñ–¥', '–æ–±—ñ–¥—É', '–≤–µ—á–µ—Ä—è', '–≤–µ—á–µ—Ä—ñ', '–≤–µ—á–µ—Ä—é',
  '–ø–µ—Ä–µ–∫—É—Å', '–ø–µ—Ä–µ–∫—É—Å—É', '–¥–µ—Å–µ—Ä—Ç', '–¥–µ—Å–µ—Ä—Ç—É',
  'breakfast', 'lunch', 'dinner', 'snack', 'dessert', 'meal',
  // taste/quality adjectives (NOT food)
  '—Å–æ–ª–æ–¥–∫–∏–π', '—Å–æ–ª–æ–¥–∫–µ', '—Å–æ–ª–æ–¥–∫—É', '—Å–æ–ª–æ–¥–∫–æ–≥–æ', '—Å–æ–ª–æ–¥–∫',
  '—Å–æ–ª–æ–Ω–∏–π', '—Å–æ–ª–æ–Ω–µ', '—Å–æ–ª–æ–Ω—É', '—Å–æ–ª–æ–Ω',
  '–≥–æ—Å—Ç—Ä–∏–π', '–≥–æ—Å—Ç—Ä–µ', '–≥–æ—Å—Ç—Ä—É', '–≥–æ—Å—Ç—Ä',
  '–ª–µ–≥–∫–∏–π', '–ª–µ–≥–∫–µ', '–ª–µ–≥–∫—É', '–ª–µ–≥–∫',
  '—Å–∏—Ç–Ω–∏–π', '—Å–∏—Ç–Ω–µ', '—Å–∏—Ç–Ω—É', '—Å–∏—Ç–Ω',
  '—à–≤–∏–¥–∫–∏–π', '—à–≤–∏–¥–∫–µ', '—à–≤–∏–¥–∫—É', '—à–≤–∏–¥–∫',
  '–ø—Ä–æ—Å—Ç–∏–π', '–ø—Ä–æ—Å—Ç–µ', '–ø—Ä–æ—Å—Ç—É', '–ø—Ä–æ—Å—Ç',
  '—Å–º–∞—á–Ω–∏–π', '—Å–º–∞—á–Ω–µ', '—Å–º–∞—á–Ω—É', '—Å–º–∞—á–Ω',
  '–∫–æ—Ä–∏—Å–Ω–∏–π', '–∫–æ—Ä–∏—Å–Ω–µ', '–∫–æ—Ä–∏—Å–Ω—É', '–∫–æ—Ä–∏—Å–Ω',
  '–¥—ñ—î—Ç–∏—á–Ω–∏–π', '–¥—ñ—î—Ç–∏—á–Ω–µ', '–¥—ñ—î—Ç–∏—á–Ω—É', '–¥—ñ—î—Ç–∏—á–Ω',
  '–∫–∞–ª–æ—Ä—ñ–π–Ω–∏–π', '–∫–∞–ª–æ—Ä—ñ–π–Ω–µ', '–∫–∞–ª–æ—Ä—ñ–π–Ω—É', '–∫–∞–ª–æ—Ä—ñ–π–Ω',
  '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω–∏–π', '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω–µ', '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω',
  '–≤–∏—Å–æ–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω–∏–π', '–≤–∏—Å–æ–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω–µ', '–≤–∏—Å–æ–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω',
  '–±—ñ–ª–∫–æ–≤–∏–π', '–±—ñ–ª–∫–æ–≤–µ', '–±—ñ–ª–∫–æ–≤—É', '–±—ñ–ª–∫–æ–≤',
  'healthy', 'light', 'quick', 'easy', 'tasty', 'simple',
  'sweet', 'savory', 'salty', 'spicy', 'low-cal', 'high-protein',
  // constraint words (handled by intent parser)
  '–±–µ–∑', '—Ü—É–∫—Ä—É', '—Ü—É–∫–æ—Ä', '–≥–ª—é—Ç–µ–Ω', '–≥–ª—é—Ç–µ–Ω—É', '–º–æ–ª–æ–∫–∞', '–ª–∞–∫—Ç–æ–∑',
  '–∂–∏—Ä—É', '–∂–∏—Ä–Ω', '–º–∞—Å–ª–∞', '–≤—É–≥–ª–µ–≤–æ–¥—ñ–≤', '–≤—É–≥–ª–µ–≤–æ–¥',
  'sugar', 'gluten', 'dairy', 'lactose', 'fat',
  // time adverbs
  '—Å—å–æ–≥–æ–¥–Ω—ñ', '–∑–∞—Ä–∞–∑', '–≤—Ä–∞–Ω—Ü—ñ', '–≤–≤–µ—á–µ—Ä—ñ', '–≤–¥–µ–Ω—å',
  // fitness goals (handled by intent parser, not products)
  '—Å—É—à–∫–∞', '—Å—É—à–∫–∏', '—Å—É—à—Ü—ñ', '—Å—É—à–∫—É', '—Å—É—à–∫',
  '–ø–æ—Ö—É–¥—ñ–Ω–Ω—è', '–ø–æ—Ö—É–¥—ñ–Ω–Ω—é', '–ø–æ—Ö—É–¥', '—Å—Ö—É–¥–Ω–µ–Ω–Ω—è', '—Å—Ö—É–¥–Ω—É—Ç–∏', '—Å—Ö—É–¥–Ω',
  '–Ω–∞–±—ñ—Ä', '–Ω–∞–±–æ—Ä—É', '–º–∞—Å–∏', '–º–∞—Å—É', '–º–∞—Å—ñ',
  "–º'—è–∑–æ–≤–æ—ó", "–º'—è–∑–æ–≤—É", "–º'—è–∑—ñ–≤", "–º'—è–∑–æ–≤",
  '—Ç—ñ–ª–∞', '—Ç—ñ–ª—É', '–≤–∞–≥–∏', '–≤–∞–≥—É', '–≤–∞–≥–æ—é',
  '–∑–±—ñ–ª—å—à–µ–Ω–Ω—è', '–∑–±—ñ–ª—å—à–∏—Ç–∏', '–∑–Ω–∏–∂–µ–Ω–Ω—è', '–∑–Ω–∏–∑–∏—Ç–∏', '–∑–º–µ–Ω—à–∏—Ç–∏',
  '—Ä–µ–ª—å—î—Ñ', '—Ä–µ–ª—å—î—Ñ—É', '–¥–µ—Ñ—ñ—Ü–∏—Ç', '–¥–µ—Ñ—ñ—Ü–∏—Ç—É', '–ø—Ä–æ—Ñ—ñ—Ü–∏—Ç', '–ø—Ä–æ—Ñ—ñ—Ü–∏—Ç—É',
  '–¥—ñ—î—Ç', '–¥—ñ—î—Ç–∏', '–¥—ñ—î—Ç—É', '–Ω–∞—Ä–æ—â—É–≤–∞–Ω–Ω—è',
  'cutting', 'bulking', 'lean', 'slim', 'bulk', 'muscle',
  // misc fillers
  '—è–∫–∏–π—Å—å', '—è–∫—ñ—Å—å', '–±—É–¥—å-—è–∫–∏–π', '–±—É–¥—å', '—è–∫–∏–π', '—è–∫–µ', '—è–∫—É', '—è–∫–∞—Å—å',
  '—â–æ–±', '–±—É–ª–æ', '–±—É–≤', '–±—É–ª–∞', '–±—É–¥–µ',
  '–¥—É–∂–µ', '—Ç–∞–∫–æ–∂', '—Ç–µ–∂', '–¥–æ–±—Ä–µ', '–º–æ–∂–µ', '–º–æ–∂–µ –±—É—Ç–∏', '—â–æ—Å—å',
  '–∞–ª–µ', '–ø—Ä–æ—Ç–µ', '–æ–¥–Ω–∞–∫', '—Ç–æ–º—É', '–±–æ',
]);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ INTENT PARSER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Detects what the user WANTS (meal type, taste, constraints)
// vs. what ingredients they listed
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Keyword ‚Üí tag mapping for intent detection
const INTENT_MEAL_TYPE = {
  '—Å–Ω—ñ–¥–∞–Ω–æ–∫': '—Å–Ω—ñ–¥–∞–Ω–æ–∫', '—Å–Ω—ñ–¥–∞–Ω–∫—É': '—Å–Ω—ñ–¥–∞–Ω–æ–∫', 'breakfast': '—Å–Ω—ñ–¥–∞–Ω–æ–∫', '–≤—Ä–∞–Ω—Ü—ñ': '—Å–Ω—ñ–¥–∞–Ω–æ–∫',
  '–æ–±—ñ–¥': '–æ–±—ñ–¥', '–æ–±—ñ–¥—É': '–æ–±—ñ–¥', 'lunch': '–æ–±—ñ–¥', '–≤–¥–µ–Ω—å': '–æ–±—ñ–¥',
  '–≤–µ—á–µ—Ä—è': '–≤–µ—á–µ—Ä—è', '–≤–µ—á–µ—Ä—ñ': '–≤–µ—á–µ—Ä—è', '–≤–µ—á–µ—Ä—é': '–≤–µ—á–µ—Ä—è', 'dinner': '–≤–µ—á–µ—Ä—è', '–≤–≤–µ—á–µ—Ä—ñ': '–≤–µ—á–µ—Ä—è',
  '–ø–µ—Ä–µ–∫—É—Å': '–ø–µ—Ä–µ–∫—É—Å', '–ø–µ—Ä–µ–∫—É—Å—É': '–ø–µ—Ä–µ–∫—É—Å', 'snack': '–ø–µ—Ä–µ–∫—É—Å',
  '—Å—É–ø': '—Å—É–ø', '—Å—É–ø—É': '—Å—É–ø', 'soup': '—Å—É–ø',
  '–¥–µ—Å–µ—Ä—Ç': '–¥–µ—Å–µ—Ä—Ç', '–¥–µ—Å–µ—Ä—Ç—É': '–¥–µ—Å–µ—Ä—Ç', 'dessert': '–¥–µ—Å–µ—Ä—Ç',
};

const INTENT_TASTE = {
  '—Å–æ–ª–æ–¥–∫': '—Å–æ–ª–æ–¥–∫', '—Å–æ–ª–æ–¥–∫–∏–π': '—Å–æ–ª–æ–¥–∫', '—Å–æ–ª–æ–¥–∫–µ': '—Å–æ–ª–æ–¥–∫', 'sweet': '—Å–æ–ª–æ–¥–∫',
  '–ª–µ–≥–∫': '–ª–µ–≥–∫', '–ª–µ–≥–∫–∏–π': '–ª–µ–≥–∫', '–ª–µ–≥–∫–µ': '–ª–µ–≥–∫', 'light': '–ª–µ–≥–∫',
  '—Å–∏—Ç–Ω': '—Å–∏—Ç–Ω', '—Å–∏—Ç–Ω–∏–π': '—Å–∏—Ç–Ω', '—Å–∏—Ç–Ω–µ': '—Å–∏—Ç–Ω', 'hearty': '—Å–∏—Ç–Ω',
  '–±—ñ–ª–∫–æ–≤': '–±—ñ–ª–æ–∫', '–±—ñ–ª–∫–æ–≤–µ': '–±—ñ–ª–æ–∫', '–±—ñ–ª–∫–æ–≤–∏–π': '–±—ñ–ª–æ–∫', '–ø—Ä–æ—Ç–µ—ó–Ω–æ–≤': '–±—ñ–ª–æ–∫', 'high-protein': '–±—ñ–ª–æ–∫',
  '–¥—ñ—î—Ç–∏—á–Ω': '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω', '–¥—ñ—î—Ç–∏—á–Ω–∏–π': '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω', '–¥—ñ—î—Ç–∏—á–Ω–µ': '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω',
  '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω': '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω', 'low-cal': '–Ω–∏–∑—å–∫–æ–∫–∞–ª–æ—Ä—ñ–π–Ω',
  '—à–≤–∏–¥–∫': '—à–≤–∏–¥–∫', '—à–≤–∏–¥–∫–∏–π': '—à–≤–∏–¥–∫', '—à–≤–∏–¥–∫–µ': '—à–≤–∏–¥–∫', 'quick': '—à–≤–∏–¥–∫',
};

const INTENT_CONSTRAINTS = {
  '–±–µ–∑ —Ü—É–∫—Ä—É': '–±–µ–∑ —Ü—É–∫—Ä—É', '–±–µ–∑ —Å–∞—Ö–∞—Ä–∞': '–±–µ–∑ —Ü—É–∫—Ä—É', 'sugar-free': '–±–µ–∑ —Ü—É–∫—Ä—É', 'without sugar': '–±–µ–∑ —Ü—É–∫—Ä—É', 'no sugar': '–±–µ–∑ —Ü—É–∫—Ä—É',
  '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É': '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É', '–±–µ–∑ –≥–ª—é—Ç–µ–Ω–∞': '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É', 'gluten-free': '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É', 'without gluten': '–±–µ–∑ –≥–ª—é—Ç–µ–Ω—É',
  '–±–µ–∑ –º–æ–ª–æ–∫–∞': '–±–µ–∑ –º–æ–ª–æ–∫–∞', '–±–µ–∑ –ª–∞–∫—Ç–æ–∑–∏': '–±–µ–∑ –º–æ–ª–æ–∫–∞', '–±–µ–∑ –º–æ–ª–æ—á–Ω': '–±–µ–∑ –º–æ–ª–æ–∫–∞', 'dairy-free': '–±–µ–∑ –º–æ–ª–æ–∫–∞', 'lactose-free': '–±–µ–∑ –º–æ–ª–æ–∫–∞',
  '–±–µ–∑ –º\'—è—Å–∞': '–≤–µ–≥–∞–Ω', '–±–µ–∑ –º—è—Å–∞': '–≤–µ–≥–∞–Ω', '–≤–µ–≥–∞–Ω': '–≤–µ–≥–∞–Ω', '–≤–µ–≥–µ—Ç–∞—Ä—ñ–∞–Ω': '–≤–µ–≥–∞–Ω', 'vegan': '–≤–µ–≥–∞–Ω', 'vegetarian': '–≤–µ–≥–∞–Ω',
};

// Fitness goal keywords ‚Üí goal type
// –°—É—à–∫–∞ (cutting): high protein, low carb, ‚â§ 450 kcal, protein ‚â• 20
// –ü–æ—Ö—É–¥—ñ–Ω–Ω—è (weight loss): ‚â§ 350 kcal
// –ù–∞–±—ñ—Ä –º–∞—Å–∏ (muscle gain): ‚â• 350 kcal, protein ‚â• 20
const INTENT_GOALS = {
  // cutting / drying
  '—Å—É—à–∫': 'dry', '—Å—É—à–∫–∞': 'dry', '—Å—É—à–∫–∏': 'dry', '—Å—É—à—Ü—ñ': 'dry',
  '–≤–∏—Å—É—à–∏—Ç–∏': 'dry', '—Ä–µ–ª—å—î—Ñ': 'dry', '—Ä–µ–ª—å—î—Ñ—É': 'dry',
  'cutting': 'dry', 'cut': 'dry', 'lean': 'dry',
  // weight loss
  '–ø–æ—Ö—É–¥—ñ–Ω': 'loss', '–ø–æ—Ö—É–¥—ñ–Ω–Ω—è': 'loss', '–ø–æ—Ö—É–¥': 'loss',
  '—Å—Ö—É–¥–Ω': 'loss', '—Å—Ö—É–¥–Ω–µ–Ω–Ω—è': 'loss', '—Å—Ö—É–¥–Ω—É—Ç–∏': 'loss',
  '–∑–Ω–∏–∂–µ–Ω–Ω—è –≤–∞–≥': 'loss', '–∑–º–µ–Ω—à–∏—Ç–∏ –≤–∞–≥—É': 'loss', '–∑–Ω–∏–∑–∏—Ç–∏ –≤–∞–≥—É': 'loss',
  '—Å–∫–∏–Ω—É—Ç–∏ –≤–∞–≥—É': 'loss', '—Å–∫–∏–Ω—É—Ç–∏': 'loss',
  '–¥–µ—Ñ—ñ—Ü–∏—Ç': 'loss', '–¥—ñ—î—Ç': 'loss',
  'weight loss': 'loss', 'lose weight': 'loss', 'slim': 'loss',
  // muscle gain
  '–Ω–∞–±—ñ—Ä –º–∞—Å': 'gain', '–Ω–∞–±—ñ—Ä –º–∞—Å–∏': 'gain', '–Ω–∞–±—Ä–∞—Ç–∏ –≤–∞–≥—É': 'gain',
  '–Ω–∞–±—Ä–∞—Ç–∏ –º–∞—Å—É': 'gain', '–∑–±—ñ–ª—å—à–∏—Ç–∏ –≤–∞–≥—É': 'gain', '–∑–±—ñ–ª—å—à–µ–Ω–Ω—è –º–∞—Å': 'gain',
  "–º'—è–∑–æ–≤": 'gain', "–º'—è–∑–æ–≤–∞ –º–∞—Å–∞": 'gain', "–º'—è–∑—ñ–≤": 'gain',
  '–ø—Ä–æ—Ñ—ñ—Ü–∏—Ç': 'gain', '–Ω–∞—Ä–æ—â—É–≤–∞–Ω–Ω—è': 'gain',
  'muscle': 'gain', 'bulk': 'gain', 'bulking': 'gain', 'mass gain': 'gain',
};

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// ‚îÄ‚îÄ‚îÄ SMART MESSAGE CLASSIFIER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Detects greetings, questions about AI, nutrition Q&A,
// off-topic messages, and unclear input BEFORE recipe search
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Known food words: all product names the AI can recognize
const KNOWN_FOOD_WORDS = new Set([
  // From SYNONYMS keys & values
  '–∫—É—Ä–∫–∞', '–∫—É—Ä—è—á', '–∫—É—Ä—è—Ç', '–∫—É—Ä–∏—á', '—Ñ–∏–ª–µ', '–≥—Ä—É–¥–∫', '—è–π—Ü', '—è—î—Ü', '—è–π–∫',
  '–ø–æ–º—ñ–¥–æ—Ä', '—Ç–æ–º–∞—Ç', '–≥—Ä–∏–±', '—à–∞–º–ø—ñ–Ω—å–π–æ–Ω', '–ø–∞—Å—Ç–∞', '—Å–ø–∞–≥–µ—Ç—ñ',
  '–º–∞–∫–∞—Ä–æ–Ω', '—Ä–∏–±', '–ª–æ—Å–æ—Å—å', '—Å—å–æ–º–≥–∞', '—Ñ–æ—Ä–µ–ª—å', '—Ç–∏–ª–∞–ø—ñ—è',
  '–≤—ñ–≤—Å—è–Ω', '–æ–≤—Å—è–Ω', '–≥–µ—Ä–∫—É–ª–µ—Å', '—ñ–Ω–¥–∏—á–∫', '—ñ–Ω–¥–∏–∫', '—ñ–Ω–¥–µ–π–∫',
  "–º'—è—Å", '—Å–≤–∏–Ω–∏–Ω', '—è–ª–æ–≤–∏—á–∏–Ω', '—Ç–µ–ª—è—Ç–∏–Ω', '–º—è—Å–æ',
  '–∫–∞—Ä—Ç–æ–ø–ª', '–∫–∞—Ä—Ç–æ—à–∫', '–∫–∞—Ä—Ç–æ—Ñ–µ–ª', '—Ü–∏–±—É–ª', '–ª—É–∫',
  '–º–æ—Ä–∫–æ–≤', '–º–æ—Ä–∫–≤–∏–Ω', '–ª–æ–∫—à–∏–Ω', '–≤–µ—Ä–º—ñ—à–µ–ª', '–ª–∞–ø—à',
  '–≥—Ä–µ—á–∫', '–≥—Ä–µ—á–∞–Ω', '—Å–æ—Å–∏—Å–∫', '–∫–æ–≤–±–∞—Å',
  '—Å–∏—Ä', '–ø–∞—Ä–º–µ–∑–∞–Ω', '—Ç–≤–æ—Ä–æ–≥', '–±–æ—Ä–æ—à–Ω–æ', '–ª–∏–º–æ–Ω',
  '–∫—Ä–µ–≤–µ—Ç–∫', '–±–∞–∫–ª–∞–∂–∞–Ω', '–æ–≥—ñ—Ä–æ–∫', '—Å–∞–ª–∞—Ç', '—à–ø–∏–Ω–∞—Ç',
  '–∫–∞–ø—É—Å—Ç–∞', '–∫–≤–∞—Å–æ–ª—è', '–≥–æ—Ä—ñ—Ö', '—Ä–∏—Å', '–±–∞–Ω–∞–Ω', '–º–æ–ª–æ–∫–æ',
  '–ø—Ä–æ—Ç–µ—ó–Ω', '–ø–µ—Ä–µ—Ü—å', '–∫–∞–±–∞—á–æ–∫', '–±—Ä–æ–∫–∫–æ–ª—ñ', '–∞–≤–æ–∫–∞–¥–æ',
  '—Ö–ª—ñ–±', '—Ç–æ—Å—Ç', '–º–µ–¥', '–º–∞—Å–ª–æ', '–æ–ª—ñ—è', '–æ–ª–∏–≤–∫–æ–≤',
  '—á–∞—Å–Ω–∏–∫', '–∑–µ–ª–µ–Ω—å', '–±–∞–∑–∏–ª—ñ–∫', '—Ä–æ–∑–º–∞—Ä–∏–Ω', '—Å–ø–µ—Ü—ñ—ó',
  '—Å–º–µ—Ç–∞–Ω', '–≤–µ—Ä—à–∫', '—Å–æ—É—Å', '–∫—É–Ω–∂—É—Ç',
  '–∫–æ–∫–æ—Å', '–º–∏–≥–¥–∞–ª—å', '—Ö—É—Ä–º–∞', '—è–±–ª—É–∫', '–≥—Ä—É—à',
  '–∞–ø–µ–ª—å—Å–∏–Ω', '–º–∞–Ω–¥–∞—Ä–∏–Ω', '–∫—ñ–≤—ñ', '–ø–æ–ª—É–Ω–∏—Ü', '—á–æ—Ä–Ω–∏—Ü',
  '–º–∞–ª–∏–Ω', '—è–≥–æ–¥', '—Å—É—Ö–æ—Ñ—Ä—É–∫—Ç', '—ñ–∑—é–º', '–∫—É—Ä–∞–≥',
  '—Å–æ—î–≤', '—Å–µ–ª–µ—Ä–∞', '—Ä–µ–¥–∏—Å', '–≥–∞—Ä–±—É–∑',
  '—Å–æ—á–µ–≤–∏—Ü', '–Ω—É—Ç', '—Ç–æ—Ñ—É', '—Ö—É–º—É—Å',
  // en food words
  'chicken', 'egg', 'rice', 'pasta', 'fish', 'beef', 'pork',
  'potato', 'tomato', 'onion', 'carrot', 'broccoli', 'banana',
  'milk', 'cheese', 'bread', 'butter', 'salmon', 'shrimp',
  'mushroom', 'avocado', 'spinach', 'oats', 'yogurt', 'turkey',
]);

// Conversational patterns the AI should handle smartly
const GREETING_PATTERNS = [
  '–ø—Ä–∏–≤—ñ—Ç', '–∑–¥—Ä–∞—Å—Ç—É–π', '–¥–æ–±—Ä–∏–π –¥–µ–Ω—å', '–¥–æ–±—Ä–æ–≥–æ –¥–Ω—è', '–¥–æ–±—Ä–∏–π —Ä–∞–Ω–æ–∫',
  '–¥–æ–±—Ä–∏–π –≤–µ—á—ñ—Ä', '–¥–æ–±—Ä–æ–≥–æ —Ä–∞–Ω–∫—É', '–¥–æ–±—Ä–æ–≥–æ –≤–µ—á–æ—Ä–∞', '–≤—ñ—Ç–∞—é',
  'hello', 'hi', 'hey', 'good morning', 'good evening', 'good afternoon',
  '–ø—Ä–∏–≤–µ—Ç', '–∑–¥–∞—Ä–æ–≤–∞', '–¥–æ–±—Ä–æ–µ —É—Ç—Ä–æ', '–¥–∞—Ä–æ–≤–∞', '—Ö–∞–π',
  '–∫—É', '–π–æ', 'yo', 'sup', 'hola', 'hii', 'hiii',
];

const ABOUT_AI_PATTERNS = [
  '—Ö—Ç–æ —Ç–∏', '—â–æ —Ç–∏ –≤–º—ñ—î—à', '—â–æ —Ç–∏ –º–æ–∂–µ—à', '—è–∫ –ø—Ä–∞—Ü—é—î—à',
  '—Ä–æ–∑–∫–∞–∂–∏ –ø—Ä–æ —Å–µ–±–µ', '—â–æ —Ç–∏ –∑–Ω–∞—î—à', '—â–æ —Ç–∏ —É–º—ñ—î—à',
  '—è–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏', '—è–∫ —Ç–æ–±–æ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏', '—è–∫—ñ —Ñ—É–Ω–∫—Ü—ñ—ó',
  '–¥–æ–ø–æ–º–æ–≥–∞', '–¥–æ–ø–æ–º–æ–∂', 'help', '—ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ',
  'who are you', 'what can you do', 'what do you do', 'how to use',
  '–∫—Ç–æ —Ç—ã', '—á—Ç–æ —Ç—ã —É–º–µ–µ—à—å', '—á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å', '–∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è',
];

const THANKS_PATTERNS = [
  '–¥—è–∫—É—é', '–¥—è–∫—É–≤–∞—Ç–∏', '–¥—è–∫', '—Å–ø–∞—Å–∏–±—ñ', '–∫–ª–∞—Å–Ω–æ', '—á—É–¥–æ–≤–æ',
  '–≤—ñ–¥–º—ñ–Ω–Ω–æ', '—Å—É–ø–µ—Ä', '–∫—Ä—É—Ç–æ', '—Ç–æ–ø',
  'thanks', 'thank you', 'thx', 'cool', 'great', 'awesome', 'nice',
  '—Å–ø–∞—Å—ñ–±–æ', '–∫–ª–∞—Å—Å', '–∫—Ä—É—Ç–æ',
];

const NUTRITION_QA_PATTERNS = [
  // Questions about calories, macros, nutrition
  { patterns: ['—Å–∫—ñ–ª—å–∫–∏ –∫–∞–ª–æ—Ä—ñ–π', '—Å–∫—ñ–ª—å–∫–∏ –∫–∫–∞–ª', '–∫–∞–ª–æ—Ä—ñ–π–Ω—ñ—Å—Ç—å', 'how many calories', 'calorie count'], key: 'calorieQuestion' },
  { patterns: ['—Å–∫—ñ–ª—å–∫–∏ –±—ñ–ª–∫', '–Ω–æ—Ä–º–∞ –±—ñ–ª–∫', '—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–æ—Ç–µ—ó–Ω', 'how much protein', 'protein intake'], key: 'proteinQuestion' },
  { patterns: ['—â–æ —Ç–∞–∫–µ –ë–ñ–£', '—â–æ —Ç–∞–∫–µ –º–∞–∫—Ä–æ', '–º–∞–∫—Ä–æ–Ω—É—Ç—Ä—ñ—î–Ω—Ç', 'macronutrient', 'what is macro'], key: 'macroQuestion' },
  { patterns: ['–∫–æ—Ä–∏—Å–Ω', '–∫–æ—Ä–∏—Å—Ç—å', '–≤—ñ—Ç–∞–º—ñ–Ω', '–º—ñ–∫—Ä–æ–µ–ª–µ–º–µ–Ω—Ç', '–∫–æ—Ä–∏—Å–Ω—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ', 'benefits', 'healthy', 'vitamin'], key: 'benefitsQuestion' },
  { patterns: ['—á–∏–º –∑–∞–º—ñ–Ω–∏—Ç–∏', '–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤', '–∑–∞–º—ñ–Ω', '–Ω–∞ —â–æ –∑–∞–º—ñ–Ω–∏—Ç–∏', 'substitute', 'replace', 'alternative'], key: 'substituteQuestion' },
  { patterns: ['—Å–∫—ñ–ª—å–∫–∏ —Ä–∞–∑—ñ–≤ –Ω–∞ –¥–µ–Ω—å', '—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–∏–π–æ–º—ñ–≤ —ó–∂—ñ', '—è–∫ —á–∞—Å—Ç–æ —ó—Å—Ç–∏', 'how often to eat', 'how many meals'], key: 'mealFrequencyQuestion' },
];

// Strict food word matching: prevents false positives from short stems
// (e.g. "—Ä–∏—Å" matching inside "—Ä–∏—Å—É–Ω–æ–∫", "—Å–∏—Ä" inside "—Å–∏—Ä–µ–Ω–∞")
const isFoodWord = (word) => {
  const w = word.toLowerCase();
  // Direct exact match
  if (KNOWN_FOOD_WORDS.has(w)) return true;
  // Check synonyms (exact or near-exact)
  for (const syn of Object.keys(SYNONYMS)) {
    // For short stems (<=3 chars), require that the word STARTS with the stem
    if (syn.length <= 3) {
      if (w.startsWith(syn) && w.length <= syn.length + 3) return true;
    } else {
      if (w.includes(syn) || syn.includes(w)) return true;
    }
  }
  // Check KNOWN_FOOD_WORDS partial match with safety
  for (const fw of KNOWN_FOOD_WORDS) {
    if (fw.length <= 3) {
      // Short food words: only match if word starts with it and is similar length
      if (w.startsWith(fw) && w.length <= fw.length + 4) return true;
      // Or word equals the food word
      if (w === fw) return true;
    } else {
      // Longer food words: partial match is OK
      if (w.includes(fw) || fw.includes(w)) return true;
    }
  }
  return false;
};

// Intent signal words that indicate the message is about food/recipes
const INTENT_SIGNAL_PATTERNS = [
  '—Ö–æ—á—É', '—Ö–æ—á', '–±–∞–∂–∞—é', '–ø–æ—Ä–∞–¥—å', '–ø–æ—Ä–∞–¥', '–∑–∞–ø—Ä–æ–ø–æ–Ω—É–π',
  '–ø—ñ–¥–∫–∞–∂–∏', '–ø—ñ–¥–∫–∞–∂', '–ø—Ä–∏–≥–æ—Ç—É–π', '–∑—Ä–æ–±–∏', '–ø–æ–∫–∞–∂–∏',
  '–¥–∞–π', '–¥–∞–≤–∞–π', '—â–æ –ø—Ä–∏–≥–æ—Ç—É–≤–∞—Ç–∏', '—â–æ –∑—Ä–æ–±–∏—Ç–∏', '—â–æ –ø–æ—ó—Å—Ç–∏',
  '–¥–ª—è —Å—É—à–∫–∏', '–¥–ª—è –ø–æ—Ö—É–¥—ñ–Ω–Ω—è', '–¥–ª—è –Ω–∞–±–æ—Ä—É', '–¥–ª—è —Ä–µ–ª—å—î—Ñ—É', '–¥–ª—è –¥—ñ—î—Ç–∏',
  '–ø—Ä–∏ —Å—É—à—Ü—ñ', '–ø—Ä–∏ –ø–æ—Ö—É–¥—ñ–Ω–Ω—ñ', '–ø—Ä–∏ –Ω–∞–±–æ—Ä—ñ', '–ø—Ä–∏ –¥–µ—Ñ—ñ—Ü–∏—Ç—ñ',
  'want', 'suggest', 'make', 'give', 'recommend',
  // meal type words (these strongly indicate food context)
  '—Å–Ω—ñ–¥–∞–Ω–æ–∫', '–æ–±—ñ–¥', '–≤–µ—á–µ—Ä', '–ø–µ—Ä–µ–∫—É—Å', '–¥–µ—Å–µ—Ä—Ç', '—Å—É–ø',
  'breakfast', 'lunch', 'dinner', 'snack',
  '—Å—É—à–∫', '–ø–æ—Ö—É–¥', '—Å—Ö—É–¥–Ω', '–Ω–∞–±—ñ—Ä –º–∞—Å',
  '–±—ñ–ª–∫–æ–≤', '–ª–µ–≥–∫', '—Å–∏—Ç–Ω', '–¥—ñ—î—Ç–∏—á–Ω', '—à–≤–∏–¥–∫',
  '—Ä–µ—Ü–µ–ø—Ç', '—Å—Ç—Ä–∞–≤', '–±–ª—é–¥', '—ó–∂',
];

// Classify message type
const classifyMessage = (text) => {
  const lower = text.toLowerCase().trim();
  const words = lower.split(/[\s,;.!?]+/).filter(w => w.length > 0);

  // 1. Greeting
  if (GREETING_PATTERNS.some(p => lower.includes(p)) && words.length <= 5) {
    return { type: 'greeting' };
  }

  // 2. Thanks / positive feedback
  if (THANKS_PATTERNS.some(p => lower.includes(p)) && words.length <= 5) {
    return { type: 'thanks' };
  }

  // 3. Questions about the AI itself
  if (ABOUT_AI_PATTERNS.some(p => lower.includes(p))) {
    return { type: 'aboutAI' };
  }

  // 4. Nutrition Q&A
  for (const qa of NUTRITION_QA_PATTERNS) {
    if (qa.patterns.some(p => lower.includes(p))) {
      return { type: 'nutritionQA', key: qa.key };
    }
  }

  // 5. Check for intent signal words (recipe/food request context)
  const hasIntentSignal = INTENT_SIGNAL_PATTERNS.some(p => lower.includes(p));
  if (hasIntentSignal) {
    return { type: 'intentRequest' };
  }

  // 6. Count strictly confirmed food words
  const contentWords = words.filter(w => w.length > 2 && !STOP_WORDS.has(w));
  let foodWordCount = 0;
  for (const w of contentWords) {
    if (isFoodWord(w)) foodWordCount++;
  }

  // If very short (1-2 words) and no food words ‚Äî unclear
  if (words.length <= 2 && foodWordCount === 0) {
    if (words.length === 1 && contentWords.length === 1 && contentWords[0].length >= 4) {
      return { type: 'unclearSingleWord', word: contentWords[0] };
    }
    return { type: 'unclear' };
  }

  // If no food words found at all ‚Äî off-topic
  if (foodWordCount === 0) {
    return { type: 'possiblyOffTopic', foodWordCount: 0 };
  }

  // Found food words ‚Äî it's a food request
  return { type: 'foodRequest', foodWordCount };
};

// Detect whether the input is a natural-language request (intent) or an ingredient list
const parseIntent = (text) => {
  const lower = text.toLowerCase();

  const mealTypes = [];
  const tastes = [];
  const constraints = [];
  let goal = null; // 'dry' | 'loss' | 'gain'

  // Check multi-word constraints first
  for (const [phrase, tag] of Object.entries(INTENT_CONSTRAINTS)) {
    if (lower.includes(phrase)) {
      constraints.push(tag);
    }
  }

  // Check multi-word goals (e.g. "–Ω–∞–±—ñ—Ä –º–∞—Å–∏", "–∑–Ω–∏–∂–µ–Ω–Ω—è –≤–∞–≥–∏", "–º'—è–∑–æ–≤–∞ –º–∞—Å–∞")
  for (const [phrase, g] of Object.entries(INTENT_GOALS)) {
    if (phrase.includes(' ') && lower.includes(phrase)) {
      goal = g;
      break;
    }
  }

  // Check single-word meal types, tastes, and goals
  const words = lower.split(/[\s,;.!?]+/);
  for (const w of words) {
    if (INTENT_MEAL_TYPE[w] && !mealTypes.includes(INTENT_MEAL_TYPE[w])) {
      mealTypes.push(INTENT_MEAL_TYPE[w]);
    }
    for (const [kw, tag] of Object.entries(INTENT_TASTE)) {
      if (w.includes(kw) || kw.includes(w)) {
        if (!tastes.includes(tag)) tastes.push(tag);
      }
    }
    // Single-word goal detection (only if not already set from multi-word)
    if (!goal) {
      for (const [kw, g] of Object.entries(INTENT_GOALS)) {
        if (!kw.includes(' ') && (w.includes(kw) || kw.includes(w))) {
          goal = g;
          break;
        }
      }
    }
  }

  const hasIntent = mealTypes.length > 0 || tastes.length > 0 || constraints.length > 0 || goal !== null;

  // "Intent words" are desire verbs or meal/taste/constraint/goal words
  const INTENT_SIGNAL_WORDS = [
    '—Ö–æ—á—É', '—Ö–æ—á', '–±–∞–∂–∞—é', '–ø–æ—Ä–∞–¥—å', '–ø–æ—Ä–∞–¥', '–∑–∞–ø—Ä–æ–ø–æ–Ω—É–π', '–ø—ñ–¥–∫–∞–∂–∏', '–ø—ñ–¥–∫–∞–∂',
    '–ø—Ä–∏–≥–æ—Ç—É–π', '–∑—Ä–æ–±–∏', '–ø–æ–∫–∞–∂–∏', 'want', 'suggest', 'make', 'give', 'recommend',
    '–¥–∞–π', '–¥–∞–≤–∞–π', '—â–æ –ø—Ä–∏–≥–æ—Ç—É–≤–∞—Ç–∏', '—â–æ –∑—Ä–æ–±–∏—Ç–∏', '—â–æ –ø–æ—ó—Å—Ç–∏',
    '–¥–ª—è —Å—É—à–∫–∏', '–¥–ª—è –ø–æ—Ö—É–¥—ñ–Ω–Ω—è', '–¥–ª—è –Ω–∞–±–æ—Ä—É', '–¥–ª—è —Ä–µ–ª—å—î—Ñ—É', '–¥–ª—è –¥—ñ—î—Ç–∏',
    '–ø—Ä–∏ —Å—É—à—Ü—ñ', '–ø—Ä–∏ –ø–æ—Ö—É–¥—ñ–Ω–Ω—ñ', '–ø—Ä–∏ –Ω–∞–±–æ—Ä—ñ', '–ø—Ä–∏ –¥–µ—Ñ—ñ—Ü–∏—Ç—ñ',
  ];
  const hasSignalWord = INTENT_SIGNAL_WORDS.some(sw => lower.includes(sw));

  return {
    isIntent: hasIntent || hasSignalWord,
    mealTypes,
    tastes,
    constraints,
    goal,
  };
};

// Search recipes by tags (intent-based) and fitness goals
const findRecipesByIntent = (intent) => {
  const { mealTypes, tastes, constraints, goal } = intent;
  const allTags = [...mealTypes, ...tastes, ...constraints];
  if (allTags.length === 0 && !goal) return [];

  // Goal-based calorie/protein filtering thresholds
  const GOAL_FILTERS = {
    dry:  { maxCal: 450, minProtein: 20, sortBy: 'proteinRatio' }, // high protein, lean
    loss: { maxCal: 350, minProtein: 0,  sortBy: 'calAsc' },       // low calorie
    gain: { minCal: 350, minProtein: 20, sortBy: 'calDesc' },      // calorie-dense + protein
  };
  const gf = goal ? GOAL_FILTERS[goal] : null;

  const scored = RECIPE_DATABASE
    .filter(r => r.tags) // only recipes with tags
    .map(recipe => {
      // Goal-based hard filters
      if (gf) {
        if (gf.maxCal && recipe.calories > gf.maxCal) return null;
        if (gf.minCal && recipe.calories < gf.minCal) return null;
        if (gf.minProtein && recipe.protein < gf.minProtein) return null;
      }

      let score = 0;
      // Goal match gives a base score so recipes pass even without other tags
      if (goal) score += 5;

      // Meal type match is most important
      for (const mt of mealTypes) {
        if (recipe.tags.some(t => t.includes(mt))) score += 3;
      }
      // Taste match
      for (const ta of tastes) {
        if (recipe.tags.some(t => t.includes(ta))) score += 2;
      }
      // Constraint match (must pass ALL constraints)
      let constraintsFailed = false;
      for (const co of constraints) {
        if (!recipe.tags.some(t => t.includes(co))) {
          constraintsFailed = true;
          break;
        }
      }
      if (constraintsFailed) return null;

      // Prefer high-protein recipes for dry/gain goals
      if (goal && recipe.protein >= 20) score += 2;
      if (goal && recipe.tags.some(t => t.includes('–±—ñ–ª–æ–∫'))) score += 1;

      return score > 0 ? { recipe, score } : null;
    })
    .filter(Boolean)
    .sort((a, b) => {
      // Goal-specific sorting
      if (gf) {
        if (gf.sortBy === 'proteinRatio') {
          const ratioA = a.recipe.protein / a.recipe.calories;
          const ratioB = b.recipe.protein / b.recipe.calories;
          if (ratioB !== ratioA) return ratioB - ratioA;
        }
        if (gf.sortBy === 'calAsc') {
          if (a.recipe.calories !== b.recipe.calories) return a.recipe.calories - b.recipe.calories;
        }
        if (gf.sortBy === 'calDesc') {
          if (a.recipe.calories !== b.recipe.calories) return b.recipe.calories - a.recipe.calories;
        }
      }
      return b.score - a.score;
    });

  return scored.slice(0, 5).map(s => s.recipe);
};

// Extract product tokens from user input and resolve synonyms
const extractProducts = (userInput) => {
  let normalized = normalizeText(userInput);
  
  const products = new Set();
  
  // First pass: find and extract compound product names (sorted by length desc for greedy match)
  const compoundKeys = Object.keys(COMPOUND_PRODUCTS).sort((a, b) => b.length - a.length);
  for (const compound of compoundKeys) {
    const compoundNorm = normalizeText(compound);
    if (normalized.includes(compoundNorm)) {
      products.add(COMPOUND_PRODUCTS[compound]);
      // Remove ALL occurrences from the string
      while (normalized.includes(compoundNorm)) {
        normalized = normalized.replace(compoundNorm, ' ');
      }
    }
  }
  
  // Second pass: split remaining text into single words
  const words = normalized.split(/[\s,;.!?]+/).filter(w => w.length > 2 && !STOP_WORDS.has(w));
  
  for (const word of words) {
    // Check synonyms (with strict matching for short stems)
    let resolved = false;
    for (const [synonym, canonical] of Object.entries(SYNONYMS)) {
      if (synonym.length <= 3) {
        // Short synonym: word must start with it and be similar length
        if (word.startsWith(synonym) && word.length <= synonym.length + 4) {
          products.add(canonical);
          resolved = true;
          break;
        }
      } else {
        if (word.includes(synonym) || synonym.includes(word)) {
          products.add(canonical);
          resolved = true;
          break;
        }
      }
    }
    // Only add as product if it's a recognized food word (NOT random words)
    if (!resolved && isFoodWord(word)) {
      products.add(word);
    }
  }
  
  return [...products];
};

// Check if a required product is covered by the user's product list
const productMatches = (required, userProducts) => {
  for (const userProd of userProducts) {
    if (required.includes(userProd) || userProd.includes(required)) {
      return true;
    }
  }
  return false;
};

// Find recipes where ALL required products are in the user's list
const findRecipes = (userInput) => {
  const userProducts = extractProducts(userInput);
  
  if (userProducts.length === 0) return [];

  const matched = RECIPE_DATABASE.filter(recipe => {
    return recipe.requiredProducts.every(req => productMatches(req, userProducts));
  });

  return matched.slice(0, 5);
};

// Human-readable product names for generated recipes
const PRODUCT_DISPLAY_NAMES = {
  // Compound products first (checked before single-word)
  '–ø–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞': '–ü–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞', '–ø–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç—É': '–ü–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–ø–µ–∫—ñ–Ω—Å—å–∫–æ—ñ –∫–∞–ø—É—Å—Ç–∏': '–ü–µ–∫—ñ–Ω—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '—Ü–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç–∞': '–¶–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç–∞', '—Ü–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç—É': '–¶–≤—ñ—Ç–Ω–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–±—Ä—é—Å—Å–µ–ª—å—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞': '–ë—Ä—é—Å—Å–µ–ª—å—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–º–æ—Ä—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞': '–ú–æ—Ä—Å—å–∫–∞ –∫–∞–ø—É—Å—Ç–∞',
  '–±–æ–ª–≥–∞—Ä—Å—å–∫–∏–π –ø–µ—Ä–µ—Ü—å': '–ë–æ–ª–≥–∞—Ä—Å—å–∫–∏–π –ø–µ—Ä–µ—Ü—å',
  '–ø–µ—Ä–µ—Ü—å —á–∏–ª—ñ': '–ü–µ—Ä–µ—Ü—å —á–∏–ª—ñ', '—á–∏–ª—ñ –ø–µ—Ä–µ—Ü—å': '–ü–µ—Ä–µ—Ü—å —á–∏–ª—ñ',
  '—Å–æ—î–≤–∏–π —Å–æ—É—Å': '–°–æ—î–≤–∏–π —Å–æ—É—Å', '–≤–µ—Ä—à–∫–æ–≤–µ –º–∞—Å–ª–æ': '–í–µ—Ä—à–∫–æ–≤–µ –º–∞—Å–ª–æ',
  '–æ–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è': '–û–ª–∏–≤–∫–æ–≤–∞ –æ–ª—ñ—è', '–∑–µ–ª–µ–Ω–∞ —Ü–∏–±—É–ª—è': '–ó–µ–ª–µ–Ω–∞ —Ü–∏–±—É–ª—è',
  '–∫—É—Ä—è—á–µ —Ñ—ñ–ª–µ': '–ö—É—Ä—è—á–µ —Ñ—ñ–ª–µ', '–∫—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞': '–ö—É—Ä—è—á–∞ –≥—Ä—É–¥–∫–∞',
  '—Ñ—ñ–ª–µ —Ä–∏–±–∏': '–§—ñ–ª–µ —Ä–∏–±–∏', '—Ä–∏–±–Ω–µ —Ñ—ñ–ª–µ': '–†–∏–±–Ω–µ —Ñ—ñ–ª–µ',
  '—Ç–æ–º–∞—Ç–Ω–∞ –ø–∞—Å—Ç–∞': '–¢–æ–º–∞—Ç–Ω–∞ –ø–∞—Å—Ç–∞', '–∞—Ä–∞—Ö—ñ—Å–æ–≤–∞ –ø–∞—Å—Ç–∞': '–ê—Ä–∞—Ö—ñ—Å–æ–≤–∞ –ø–∞—Å—Ç–∞',
  '–≥—Ä–µ—Ü—å–∫—ñ –≥–æ—Ä—ñ—Ö–∏': '–ì—Ä–µ—Ü—å–∫—ñ –≥–æ—Ä—ñ—Ö–∏', '–≥—Ä–µ—Ü—å–∫–∏–π –≥–æ—Ä—ñ—Ö': '–ì—Ä–µ—Ü—å–∫—ñ –≥–æ—Ä—ñ—Ö–∏',
  '–≤—ñ–≤—Å—è–Ω—ñ –ø–ª–∞—Å—Ç—ñ–≤—Ü—ñ': '–í—ñ–≤—Å—è–Ω—ñ –ø–ª–∞—Å—Ç—ñ–≤—Ü—ñ',
  '—Å—Ç—Ä—É—á–∫–æ–≤–∞ –∫–≤–∞—Å–æ–ª—è': '–°—Ç—Ä—É—á–∫–æ–≤–∞ –∫–≤–∞—Å–æ–ª—è',
  '–∫–æ–∫–æ—Å–æ–≤–µ –º–æ–ª–æ–∫–æ': '–ö–æ–∫–æ—Å–æ–≤–µ –º–æ–ª–æ–∫–æ', '–º–∏–≥–¥–∞–ª—å–Ω–µ –º–æ–ª–æ–∫–æ': '–ú–∏–≥–¥–∞–ª—å–Ω–µ –º–æ–ª–æ–∫–æ',
  '–ø–ª–∞–≤–ª–µ–Ω–∏–π —Å–∏—Ä': '–ü–ª–∞–≤–ª–µ–Ω–∏–π —Å–∏—Ä', '–∫–æ–∑—è—á–∏–π —Å–∏—Ä': '–ö–æ–∑—è—á–∏–π —Å–∏—Ä',
  '—Ä–∏—Å–æ–≤–∞ –ª–æ–∫—à–∏–Ω–∞': '–†–∏—Å–æ–≤–∞ –ª–æ–∫—à–∏–Ω–∞',
  // Single-word products
  '–∫—É—Ä–∫–∞': '–ö—É—Ä–∫–∞', '—è–π—Ü': '–Ø–π—Ü—è', '–ø–æ–º—ñ–¥–æ—Ä': '–ü–æ–º—ñ–¥–æ—Ä–∏', '—Å–∏—Ä': '–°–∏—Ä',
  '–≥—Ä–∏–±': '–ì—Ä–∏–±–∏', '–ø–∞—Å—Ç–∞': '–ü–∞—Å—Ç–∞', '–º–∞–∫–∞—Ä–æ–Ω': '–ú–∞–∫–∞—Ä–æ–Ω–∏', '—Ä–∏–±': '–†–∏–±–∞',
  '–≤—ñ–≤—Å—è–Ω': '–í—ñ–≤—Å—è–Ω–∫–∞', '—ñ–Ω–¥–∏—á–∫': '–Ü–Ω–¥–∏—á–∫–∞', "–º'—è—Å": "–ú'—è—Å–æ", '–∫–∞—Ä—Ç–æ–ø–ª': '–ö–∞—Ä—Ç–æ–ø–ª—è',
  '—Ü–∏–±—É–ª': '–¶–∏–±—É–ª—è', '–º–æ—Ä–∫–æ–≤': '–ú–æ—Ä–∫–≤–∞', '–ª–æ–∫—à–∏–Ω': '–õ–æ–∫—à–∏–Ω–∞', '–≥—Ä–µ—á–∫': '–ì—Ä–µ—á–∫–∞',
  '–∫–æ–≤–±–∞—Å': '–ö–æ–≤–±–∞—Å–∞', '—Ä–∏—Å': '–†–∏—Å', '–±–∞–Ω–∞–Ω': '–ë–∞–Ω–∞–Ω', '–º–æ–ª–æ–∫–æ': '–ú–æ–ª–æ–∫–æ',
  '–ø—Ä–æ—Ç–µ—ó–Ω': '–ü—Ä–æ—Ç–µ—ó–Ω', '–ø–µ—Ä–µ—Ü—å': '–ü–µ—Ä–µ—Ü—å', '–∫–∞–±–∞—á–æ–∫': '–ö–∞–±–∞—á–æ–∫', '–±—Ä–æ–∫–∫–æ–ª—ñ': '–ë—Ä–æ–∫–∫–æ–ª—ñ',
  '–∞–≤–æ–∫–∞–¥–æ': '–ê–≤–æ–∫–∞–¥–æ', '—Ö–ª—ñ–±': '–•–ª—ñ–±', '—Ç–≤–æ—Ä–æ–≥': '–¢–≤–æ—Ä–æ–≥', '–±–æ—Ä–æ—à–Ω–æ': '–ë–æ—Ä–æ—à–Ω–æ',
  '–ª–∏–º–æ–Ω': '–õ–∏–º–æ–Ω', '–∫—Ä–µ–≤–µ—Ç–∫': '–ö—Ä–µ–≤–µ—Ç–∫–∏', '–±–∞–∫–ª–∞–∂–∞–Ω': '–ë–∞–∫–ª–∞–∂–∞–Ω', '–æ–≥—ñ—Ä–æ–∫': '–û–≥—ñ—Ä–æ–∫',
  '—Å–∞–ª–∞—Ç': '–°–∞–ª–∞—Ç', '–ø–∞—Ä–º–µ–∑–∞–Ω': '–ü–∞—Ä–º–µ–∑–∞–Ω', '—à–ø–∏–Ω–∞—Ç': '–®–ø–∏–Ω–∞—Ç',
  '–∫–∞–ø—É—Å—Ç–∞': '–ö–∞–ø—É—Å—Ç–∞', '–∫–≤–∞—Å–æ–ª—è': '–ö–≤–∞—Å–æ–ª—è', '–≥–æ—Ä—ñ—Ö': '–ì–æ—Ä—ñ—Ö–∏',
};

const getDisplayName = (product) => {
  for (const [key, name] of Object.entries(PRODUCT_DISPLAY_NAMES)) {
    if (product.includes(key) || key.includes(product)) return name;
  }
  // Capitalize first letter of user input
  return product.charAt(0).toUpperCase() + product.slice(1);
};

// Cooking methods for variety in generated recipes
const COOKING_METHODS = [
  {
    name: (products) => `${products.join(', ')} –Ω–∞ —Å–∫–æ–≤–æ—Ä–æ–¥—ñ`,
    time: '20 —Ö–≤',
    getInstructions: (products) =>
      `–ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –≤—Å—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏: –ø–æ–º–∏—Ç–∏, –ø–æ—á–∏—Å—Ç–∏—Ç–∏, –Ω–∞—Ä—ñ–∑–∞—Ç–∏. –†–æ–∑—ñ–≥—Ä—ñ—Ç–∏ —Å–∫–æ–≤–æ—Ä–æ–¥—É –∑ –æ–ª—ñ—î—é. –ü–æ–∫–ª–∞—Å—Ç–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏, –ø–æ—á–∏–Ω–∞—é—á–∏ –∑ —Ç–∏—Ö, —â–æ –≥–æ—Ç—É—é—Ç—å—Å—è –¥–æ–≤—à–µ. –°–º–∞–∂–∏—Ç–∏ –Ω–∞ —Å–µ—Ä–µ–¥–Ω—å–æ–º—É –≤–æ–≥–Ω—ñ, –ø–æ–º—ñ—à—É—é—á–∏, 12-15 —Ö–≤ –¥–æ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ. –î–æ–¥–∞—Ç–∏ —Å—ñ–ª—å, –ø–µ—Ä–µ—Ü—å —Ç–∞ —Å–ø–µ—Ü—ñ—ó –∑–∞ —Å–º–∞–∫–æ–º.`,
  },
  {
    name: (products) => `${products.join(', ')} –∑–∞–ø–µ—á–µ–Ω—ñ –≤ –¥—É—Ö–æ–≤—Ü—ñ`,
    time: '35 —Ö–≤',
    getInstructions: (products) =>
      `–ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –≤—Å—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏: –ø–æ–º–∏—Ç–∏, –Ω–∞—Ä—ñ–∑–∞—Ç–∏ —Å–µ—Ä–µ–¥–Ω—ñ–º–∏ —à–º–∞—Ç–∫–∞–º–∏. –í–∏–∫–ª–∞—Å—Ç–∏ –Ω–∞ –¥–µ–∫–æ, –∑–∞—Å—Ç–µ–ª–µ–Ω–µ –ø–µ—Ä–≥–∞–º–µ–Ω—Ç–æ–º. –ü–æ–ª–∏—Ç–∏ –æ–ª–∏–≤–∫–æ–≤–æ—é –æ–ª—ñ—î—é, –¥–æ–¥–∞—Ç–∏ —Å—ñ–ª—å, –ø–µ—Ä–µ—Ü—å —Ç–∞ —É–ª—é–±–ª–µ–Ω—ñ —Å–ø–µ—Ü—ñ—ó. –ó–∞–ø—ñ–∫–∞—Ç–∏ –≤ —Ä–æ–∑—ñ–≥—Ä—ñ—Ç—ñ–π –¥—É—Ö–æ–≤—Ü—ñ –ø—Ä–∏ 190¬∞–° –ø—Ä–æ—Ç—è–≥–æ–º 25-30 —Ö–≤ –¥–æ –∑–æ–ª–æ—Ç–∏—Å—Ç–æ—ó —Å–∫–æ—Ä–∏–Ω–∫–∏.`,
  },
  {
    name: (products) => `–°—É–ø –∑ ${products.join(', ').toLowerCase()}`,
    time: '30 —Ö–≤',
    getInstructions: (products) =>
      `–ù–∞—Ä—ñ–∑–∞—Ç–∏ –≤—Å—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏ –∫—É–±–∏–∫–∞–º–∏ –∞–±–æ —Å–∫–∏–±–æ—á–∫–∞–º–∏. –î–æ–≤–µ—Å—Ç–∏ –≤–æ–¥—É (1.5–ª) –¥–æ –∫–∏–ø—ñ–Ω–Ω—è, –ø—ñ–¥—Å–æ–ª–∏—Ç–∏. –î–æ–¥–∞—Ç–∏ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏, –ø–æ—á–∏–Ω–∞—é—á–∏ –∑ —Ç–∏—Ö, —â–æ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å –±—ñ–ª—å—à–µ —á–∞—Å—É. –í–∞—Ä–∏—Ç–∏ 20-25 —Ö–≤ –Ω–∞ —Å–µ—Ä–µ–¥–Ω—å–æ–º—É –≤–æ–≥–Ω—ñ. –î–æ–¥–∞—Ç–∏ –∑–µ–ª–µ–Ω—å —Ç–∞ —Å–ø–µ—Ü—ñ—ó –∑–∞ —Å–º–∞–∫–æ–º –ø–µ—Ä–µ–¥ –ø–æ–¥–∞—á–µ—é.`,
  },
  {
    name: (products) => `–°–∞–ª–∞—Ç –∑ ${products.join(', ').toLowerCase()}`,
    time: '15 —Ö–≤',
    getInstructions: (products) =>
      `–ü—ñ–¥–≥–æ—Ç—É–≤–∞—Ç–∏ –≤—Å—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏: –ø–æ–º–∏—Ç–∏, –Ω–∞—Ä—ñ–∑–∞—Ç–∏ –∞–±–æ –Ω–∞—Ç–µ—Ä—Ç–∏. –°–∫–ª–∞—Å—Ç–∏ —É –≥–ª–∏–±–æ–∫—É –º–∏—Å–∫—É. –ó–∞–ø—Ä–∞–≤–∏—Ç–∏ –æ–ª–∏–≤–∫–æ–≤–æ—é –æ–ª—ñ—î—é –∑ –ª–∏–º–æ–Ω–Ω–∏–º —Å–æ–∫–æ–º (–∞–±–æ —ñ–Ω—à–æ—é –∑–∞–ø—Ä–∞–≤–∫–æ—é –∑–∞ —Å–º–∞–∫–æ–º). –î–æ–¥–∞—Ç–∏ —Å—ñ–ª—å —Ç–∞ –ø–µ—Ä–µ—Ü—å. –ü–µ—Ä–µ–º—ñ—à–∞—Ç–∏ —Ç–∞ –ø–æ–¥–∞–≤–∞—Ç–∏.`,
  },
  {
    name: (products) => `–¢—É—à–∫–æ–≤–∞–Ω—ñ ${products.join(', ').toLowerCase()}`,
    time: '40 —Ö–≤',
    getInstructions: (products) =>
      `–ù–∞—Ä—ñ–∑–∞—Ç–∏ –≤—Å—ñ —ñ–Ω–≥—Ä–µ–¥—ñ—î–Ω—Ç–∏. –û–±—Å–º–∞–∂–∏—Ç–∏ –Ω–∞ –æ–ª—ñ—ó –≤ –∫–∞—Å—Ç—Ä—É–ª—ñ –∑ —Ç–æ–≤—Å—Ç–∏–º –¥–Ω–æ–º 3-5 —Ö–≤. –ó–∞–ª–∏—Ç–∏ –Ω–µ–≤–µ–ª–∏–∫–æ—é –∫—ñ–ª—å–∫—ñ—Å—Ç—é –≤–æ–¥–∏ –∞–±–æ –±—É–ª—å–π–æ–Ω—É (200–º–ª). –î–æ–¥–∞—Ç–∏ —Å—ñ–ª—å, –ø–µ—Ä–µ—Ü—å, –ª–∞–≤—Ä–æ–≤–∏–π –ª–∏—Å—Ç. –¢—É—à–∫—É–≤–∞—Ç–∏ –ø—ñ–¥ –∫—Ä–∏—à–∫–æ—é –Ω–∞ –º–∞–ª–æ–º—É –≤–æ–≥–Ω—ñ 25-30 —Ö–≤ –¥–æ –ø–æ–≤–Ω–æ—ó –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç—ñ.`,
  },
];

// Determine the proper amount and unit for a product based on its type
const getProductAmount = (product, isSoup) => {
  const p = product.toLowerCase();
  
  // Oils & liquid fats ‚Üí –º–ª (max 30 –º–ª for non-soup, 45 –º–ª for soup)
  if (p.includes('–æ–ª—ñ') || p.includes('–æ–ª—ñ—è') || p.includes('–æ–ª–∏–≤–∫–æ–≤')) {
    return isSoup ? '30 –º–ª' : '15 –º–ª';
  }
  if (p.includes('–º–∞—Å–ª') || p.includes('–º–∞—Å–ª–æ')) {
    return isSoup ? '30 –≥' : '15 –≥';
  }
  // Sauces
  if (p.includes('—Å–æ—É—Å') || p.includes('–ø–∞—Å—Ç–∞') && (p.includes('—Ç–æ–º–∞—Ç') || p.includes('–∞—Ä–∞—Ö—ñ—Å'))) {
    return '2 —Å—Ç.–ª.';
  }
  // Liquids ‚Üí –º–ª
  if (p.includes('–º–æ–ª–æ–∫') || p.includes('—Å—ñ–∫') || p.includes('–±—É–ª—å–π–æ–Ω') || p.includes('–≤–µ—Ä—à–∫') || p.includes('—Å–º–µ—Ç–∞–Ω')) {
    return '200 –º–ª';
  }
  // Countable items ‚Üí —à—Ç
  if (p.includes('—è–π—Ü') || p.includes('—è—î—Ü')) return '2 —à—Ç';
  if (p.includes('–±–∞–Ω–∞–Ω') || p.includes('–ª–∏–º–æ–Ω') || p.includes('–æ–≥—ñ—Ä–æ–∫') || p.includes('–∞–≤–æ–∫–∞–¥–æ')) return '1 —à—Ç';
  if (p.includes('–ø–æ–º—ñ–¥–æ—Ä') || p.includes('–ø–µ—Ä–µ—Ü—å') || p.includes('—Ü–∏–±—É–ª')) return '1 —à—Ç';
  if (p.includes('–∫–∞—Ä—Ç–æ–ø–ª')) return '2 —à—Ç';
  // Light greens, leaves ‚Üí –≥ small
  if (p.includes('—Å–∞–ª–∞—Ç') || p.includes('—à–ø–∏–Ω–∞—Ç') || p.includes('–∑–µ–ª–µ–Ω') || p.includes('–±–∞–∑–∏–ª—ñ–∫')) return '50 –≥';
  if (p.includes('–∫–∞–ø—É—Å—Ç–∞') || p.includes('–∫–∞–ø—É—Å—Ç—É') || p.includes('–∫–∞–ø—É—Å—Ç–∏')) return '200 –≥';
  // Cereals, grains
  if (p.includes('—Ä–∏—Å') || p.includes('–≥—Ä–µ—á–∫') || p.includes('–≤—ñ–≤—Å—è–Ω') || p.includes('–ø–ª–∞—Å—Ç—ñ–≤—Ü')) return '150 –≥';
  if (p.includes('–ø–∞—Å—Ç–∞') || p.includes('–º–∞–∫–∞—Ä–æ–Ω') || p.includes('–ª–æ–∫—à–∏–Ω') || p.includes('—Å–ø–∞–≥–µ—Ç—ñ')) return '200 –≥';
  if (p.includes('–±–æ—Ä–æ—à–Ω–æ')) return '100 –≥';
  // Cheese
  if (p.includes('—Å–∏—Ä') || p.includes('–ø–∞—Ä–º–µ–∑–∞–Ω')) return '50 –≥';
  if (p.includes('—Ç–≤–æ—Ä–æ–≥')) return '200 –≥';
  // Nuts
  if (p.includes('–≥–æ—Ä—ñ—Ö')) return '30 –≥';
  // Meat, fish, poultry ‚Üí –≥
  if (p.includes('–∫—É—Ä–∫') || p.includes('–∫—É—Ä—è—á') || p.includes('—Ñ—ñ–ª–µ') || p.includes('–≥—Ä—É–¥–∫')) return '200 –≥';
  if (p.includes('—ñ–Ω–¥–∏—á') || p.includes('—ñ–Ω–¥–∏–∫')) return '200 –≥';
  if (p.includes("–º'—è—Å") || p.includes('—Å–≤–∏–Ω–∏–Ω') || p.includes('—è–ª–æ–≤–∏—á–∏–Ω') || p.includes('–≤–∏—Ä—ñ–∑–∫')) return '200 –≥';
  if (p.includes('—Ä–∏–±') || p.includes('–ª–æ—Å–æ—Å—å') || p.includes('—Å—å–æ–º–≥–∞') || p.includes('—Ñ–æ—Ä–µ–ª—å')) return '200 –≥';
  if (p.includes('–∫—Ä–µ–≤–µ—Ç–∫')) return '200 –≥';
  if (p.includes('–∫–æ–≤–±–∞—Å')) return '100 –≥';
  // Mushrooms, vegetables
  if (p.includes('–≥—Ä–∏–±') || p.includes('—à–∞–º–ø—ñ–Ω—å–π–æ–Ω')) return '150 –≥';
  if (p.includes('–∫–∞–±–∞—á–æ–∫') || p.includes('–±–∞–∫–ª–∞–∂–∞–Ω') || p.includes('–±—Ä–æ–∫–∫–æ–ª—ñ')) return '150 –≥';
  if (p.includes('–º–æ—Ä–∫–æ–≤')) return '1 —à—Ç';
  if (p.includes('–∫–≤–∞—Å–æ–ª—è')) return '100 –≥';
  if (p.includes('—Ö–ª—ñ–±') || p.includes('—Ç–æ—Å—Ç')) return '2 —Å–∫–∏–±–∫–∏';
  if (p.includes('–ø—Ä–æ—Ç–µ—ó–Ω')) return '1 –ø–æ—Ä—Ü—ñ—è';
  // Default
  return '150 –≥';
};

// Generate a recipe dynamically from the user's products
const generateRecipe = (userInput) => {
  const userProducts = extractProducts(userInput);
  if (userProducts.length === 0) return null;

  // Deduplicate: if two products resolve to the same display name, keep only one
  const seen = new Set();
  const uniqueProducts = [];
  for (const prod of userProducts) {
    const display = getDisplayName(prod);
    if (!seen.has(display)) {
      seen.add(display);
      uniqueProducts.push(prod);
    }
  }

  const displayNames = uniqueProducts.map(getDisplayName);
  
  // Pick a cooking method based on content hash for consistency
  const hash = userInput.length + uniqueProducts.length;
  const method = COOKING_METHODS[hash % COOKING_METHODS.length];
  const isSoup = method === COOKING_METHODS[2]; // soup method

  // Estimate calories & protein based on product count
  const baseCal = 150 + uniqueProducts.length * 60;
  const baseProt = 8 + uniqueProducts.length * 5;

  const ingredients = displayNames.map((name) => {
    return `${name} - ${getProductAmount(name, isSoup)}`;
  });
  ingredients.push('–°—ñ–ª—å, –ø–µ—Ä–µ—Ü—å, —Å–ø–µ—Ü—ñ—ó –∑–∞ —Å–º–∞–∫–æ–º');
  
  // Only add oil if user didn't already list it
  const hasOil = uniqueProducts.some(p => 
    p.includes('–æ–ª—ñ') || p.includes('–æ–ª—ñ—è') || p.includes('–º–∞—Å–ª') || p.includes('–æ–ª–∏–≤–∫')
  );
  if (!hasOil) {
    ingredients.push(`–û–ª—ñ—è - ${isSoup ? '15 –º–ª' : '15 –º–ª'}`);
  }

  return {
    name: method.name(displayNames),
    time: method.time,
    calories: baseCal,
    protein: baseProt,
    ingredients,
    instructions: method.getInstructions(displayNames),
  };
};

const Message = ({ isUser, text, children, t }) => (
  <View style={[styles.message, isUser && styles.messageUser]}>
    <View style={[styles.avatar, isUser ? styles.avatarUser : styles.avatarAI]}>
      <Text style={styles.avatarText}>{isUser ? t('aiRecipes.me') : 'AI'}</Text>
    </View>
    <View style={[styles.messageBubble, isUser ? styles.messageBubbleUser : styles.messageBubbleAI]}>
      {text && <Text style={styles.messageText}>{text}</Text>}
      {children}
    </View>
  </View>
);

const RecipeCard = ({ recipe, t }) => (
  <View style={styles.recipeCard}>
    <View style={styles.recipeHeader}>
      <Text style={styles.recipeName}>{recipe.name}</Text>
      <View style={styles.recipeStats}>
        <View style={styles.recipeStat}>
          <Ionicons name="time-outline" size={14} color="#BBE0FF" />
          <Text style={styles.recipeStatText}>{recipe.time}</Text>
        </View>
        <View style={styles.recipeStat}>
          <Ionicons name="flame-outline" size={14} color="#FFAD8F" />
          <Text style={styles.recipeStatText}>{recipe.calories} {t('diary.kcal')}</Text>
        </View>
        <View style={styles.recipeStat}>
          <Text style={styles.recipeStatText}>{t('aiRecipes.proteinShort')}: {recipe.protein}{t('units.g')}</Text>
        </View>
      </View>
    </View>
    
    <Text style={styles.sectionLabel}>{t('aiRecipes.ingredients')}:</Text>
    {recipe.ingredients.map((ing, idx) => (
      <Text key={idx} style={styles.ingredientItem}>‚Ä¢ {ing}</Text>
    ))}
    
    <Text style={styles.sectionLabel}>{t('aiRecipes.instructions')}:</Text>
    <Text style={styles.instructions}>{recipe.instructions}</Text>
  </View>
);

export const AIRecipesScreen = ({ navigation, route }) => {
  const { t } = useTranslation();
  const [messages, setMessages] = useState([]);
  const [inputText, setInputText] = useState('');
  const [isTyping, setIsTyping] = useState(false);
  const scrollViewRef = useRef(null);
  const [initialized, setInitialized] = useState(false);

  // Chat persistence
  const { createConversation, loadConversation, saveMessages: saveChat } = useChatStore();
  const conversationIdRef = useRef(route?.params?.conversationId || null);
  const saveTimerRef = useRef(null);

  // Auto-save messages (debounced)
  const debouncedSave = useCallback((msgs) => {
    if (saveTimerRef.current) clearTimeout(saveTimerRef.current);
    saveTimerRef.current = setTimeout(() => {
      if (conversationIdRef.current && msgs.length > 0) {
        const title = t('ai.recipesTitle');
        saveChat(conversationIdRef.current, msgs, title);
      }
    }, 1500);
  }, [saveChat, t]);

  // Save whenever messages change
  useEffect(() => {
    if (initialized && messages.length > 0) {
      debouncedSave(messages);
    }
  }, [messages, initialized, debouncedSave]);

  useEffect(() => {
    if (!initialized) {
      const init = async () => {
        // Load existing conversation if ID given
        if (conversationIdRef.current) {
          const loaded = await loadConversation(conversationIdRef.current);
          if (loaded && loaded.length > 0) {
            setMessages(loaded);
            setInitialized(true);
            return;
          }
        }

        // Create new conversation
        if (!conversationIdRef.current) {
          const newId = await createConversation('recipes');
          if (newId) conversationIdRef.current = newId;
        }

        setMessages([
          { 
            isUser: false, 
            text: t('aiRecipes.greeting'),
          },
        ]);
        setInitialized(true);
      };
      init();
    }
  }, [t, initialized]);

  // Helper to push AI message with typing delay
  const pushAIMessage = (msgOrMsgs, delay = 1200) => {
    setIsTyping(true);
    setTimeout(() => {
      setIsTyping(false);
      if (Array.isArray(msgOrMsgs)) {
        setMessages(prev => [...prev, ...msgOrMsgs]);
      } else {
        setMessages(prev => [...prev, msgOrMsgs]);
      }
    }, delay);
  };

  const handleSend = () => {
    if (!inputText.trim()) return;

    const userMessage = inputText.trim();
    setInputText('');
    
    setMessages(prev => [...prev, { isUser: true, text: userMessage }]);

    // ‚îÄ‚îÄ Censorship check ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    if (containsBannedContent(userMessage)) {
      setMessages(prev => [...prev, {
        isUser: false,
        text: t('aiRecipes.censorWarning'),
      }]);
      return;
    }

    // ‚îÄ‚îÄ Smart message classification ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const classification = classifyMessage(userMessage);

    // Handle conversational messages immediately (no delay needed)
    if (classification.type === 'greeting') {
      pushAIMessage({ isUser: false, text: t('aiRecipes.greetingReply') }, 800);
      return;
    }
    if (classification.type === 'thanks') {
      pushAIMessage({ isUser: false, text: t('aiRecipes.thanksReply') }, 800);
      return;
    }
    if (classification.type === 'aboutAI') {
      pushAIMessage({ isUser: false, text: t('aiRecipes.aboutAI') }, 1000);
      return;
    }
    if (classification.type === 'nutritionQA') {
      pushAIMessage({ isUser: false, text: t(`aiRecipes.${classification.key}`) }, 1200);
      return;
    }
    if (classification.type === 'unclear') {
      pushAIMessage({ isUser: false, text: t('aiRecipes.clarifyRequest') }, 1000);
      return;
    }
    if (classification.type === 'unclearSingleWord') {
      pushAIMessage({ isUser: false, text: t('aiRecipes.clarifySingleWord').replace('{{word}}', classification.word) }, 1000);
      return;
    }
    if (classification.type === 'possiblyOffTopic') {
      pushAIMessage({ isUser: false, text: t('aiRecipes.offTopicClarify') }, 1000);
      return;
    }

    // ‚îÄ‚îÄ From here: message is either intentRequest or foodRequest ‚îÄ‚îÄ
    setIsTyping(true);

    setTimeout(() => {
      setIsTyping(false);

      // ‚îÄ‚îÄ Step 1: Detect intent (natural-language request) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
      const intent = parseIntent(userMessage);

      if (intent.isIntent) {
        // User described what they WANT ‚Äî search by tags
        const intentRecipes = findRecipesByIntent(intent);

        if (intentRecipes.length > 0) {
          const analysis = analyzeRecipes(intentRecipes, intent, t);
          const msgs = [{
            isUser: false,
            text: `${t('aiRecipes.recipesFound')} (${intentRecipes.length}):`,
            recipes: intentRecipes,
          }];
          if (analysis) {
            msgs.push({ isUser: false, text: analysis });
          }
          setMessages(prev => [...prev, ...msgs]);
          return;
        }

        // Intent detected but no matching recipes
        // Try product-based search as fallback
        const mixedRecipes = findRecipes(userMessage);
        if (mixedRecipes.length > 0) {
          const analysis = analyzeRecipes(mixedRecipes, intent, t);
          const msgs = [{
            isUser: false,
            text: `${t('aiRecipes.recipesFound')} (${mixedRecipes.length}):`,
            recipes: mixedRecipes,
          }];
          if (analysis) {
            msgs.push({ isUser: false, text: analysis });
          }
          setMessages(prev => [...prev, ...msgs]);
          return;
        }

        // No results at all ‚Äî give a helpful message
        setMessages(prev => [...prev, {
          isUser: false,
          text: t('aiRecipes.intentNoMatch'),
        }]);
        return;
      }

      // ‚îÄ‚îÄ Step 2: Treat as ingredient list (only reaches here if foodRequest) ‚îÄ‚îÄ
      const matchedRecipes = findRecipes(userMessage);
      
      if (matchedRecipes.length > 0) {
        const analysis = analyzeRecipes(matchedRecipes, null, t);
        const msgs = [{ 
          isUser: false, 
          text: `${t('aiRecipes.recipesFound')} (${matchedRecipes.length}):`,
          recipes: matchedRecipes,
        }];
        if (analysis) {
          msgs.push({ isUser: false, text: analysis });
        }
        setMessages(prev => [...prev, ...msgs]);
      } else {
        // extractProducts now only returns confirmed food words
        const userProducts = extractProducts(userMessage);

        if (userProducts.length >= 1) {
          const generated = generateRecipe(userMessage);
          if (generated) {
            const genAnalysis = analyzeGeneratedRecipe(generated, t);
            const msgs = [{ 
              isUser: false, 
              text: t('aiRecipes.generatedRecipe'),
              recipes: [generated],
            }];
            if (genAnalysis) {
              msgs.push({ isUser: false, text: genAnalysis });
            }
            setMessages(prev => [...prev, ...msgs]);
          } else {
            setMessages(prev => [...prev, { 
              isUser: false, 
              text: t('aiRecipes.noRecipesFound'),
            }]);
          }
        } else {
          // No recognized food words at all ‚Äî ask for clarification
          setMessages(prev => [...prev, { 
            isUser: false, 
            text: t('aiRecipes.notFoodClarify'),
          }]);
        }
      }
    }, 1500);
  };

  useEffect(() => {
    scrollViewRef.current?.scrollToEnd({ animated: true });
  }, [messages, isTyping]);

  return (
    <PremiumGate feature={t('ai.recipes')}>
    <SafeAreaView style={styles.container}>
      <View style={styles.header}>
        <TouchableOpacity style={styles.backButton} onPress={() => navigation.goBack()}>
          <Ionicons name="chevron-back" size={24} color={Colors.white} />
        </TouchableOpacity>
        <Text style={styles.title}>{t('aiRecipes.title')}</Text>
        <View style={{ width: 42 }} />
      </View>

      <KeyboardAvoidingView
        behavior={Platform.OS === 'ios' ? 'padding' : 'height'}
        style={styles.chatContainer}
        keyboardVerticalOffset={90}
      >
        <ScrollView 
          ref={scrollViewRef}
          style={styles.chatContent}
          contentContainerStyle={styles.chatContentInner}
          showsVerticalScrollIndicator={false}
        >
          {messages.map((msg, idx) => (
            <Message key={idx} isUser={msg.isUser} text={msg.text} t={t}>
              {msg.recipes && (
                <View style={styles.recipesContainer}>
                  {msg.recipes.map((recipe, rIdx) => (
                    <RecipeCard key={rIdx} recipe={recipe} t={t} />
                  ))}
                </View>
              )}
            </Message>
          ))}
          
          {isTyping && (
            <View style={styles.typingIndicator}>
              <View style={[styles.avatar, styles.avatarAI]}>
                <Text style={styles.avatarText}>AI</Text>
              </View>
              <View style={styles.typingDots}>
                <ActivityIndicator size="small" color={Colors.primary} />
                <Text style={styles.typingText}>{t('aiRecipes.searchingRecipes')}</Text>
              </View>
            </View>
          )}
        </ScrollView>

        <View style={styles.inputContainer}>
          <TextInput
            style={styles.input}
            placeholder={t('aiRecipes.searchPlaceholder')}
            placeholderTextColor="rgba(255,255,255,0.4)"
            value={inputText}
            onChangeText={setInputText}
            multiline
            maxLength={500}
          />
          <TouchableOpacity 
            style={[styles.sendButton, !inputText.trim() && styles.sendButtonDisabled]}
            onPress={handleSend}
            disabled={!inputText.trim()}
          >
            <Ionicons name="send" size={20} color={inputText.trim() ? Colors.dark : 'rgba(0,0,0,0.3)'} />
          </TouchableOpacity>
        </View>
      </KeyboardAvoidingView>
    </SafeAreaView>
    </PremiumGate>
  );
};

const styles = StyleSheet.create({
  container: {
    flex: 1,
    backgroundColor: Colors.dark,
  },
  header: {
    flexDirection: 'row',
    alignItems: 'center',
    justifyContent: 'space-between',
    paddingHorizontal: 23,
    paddingVertical: 15,
  },
  backButton: {
    width: 42,
    height: 42,
    backgroundColor: 'rgba(244,244,244,0.1)',
    borderRadius: 21,
    alignItems: 'center',
    justifyContent: 'center',
  },
  title: {
    fontSize: 20,
    fontWeight: '500',
    color: Colors.white,
    textTransform: 'uppercase',
  },
  chatContainer: {
    flex: 1,
  },
  chatContent: {
    flex: 1,
    paddingHorizontal: 23,
  },
  chatContentInner: {
    paddingBottom: 20,
    gap: 15,
  },
  message: {
    flexDirection: 'row',
    gap: 12,
    alignItems: 'flex-start',
  },
  messageUser: {
    flexDirection: 'row-reverse',
  },
  avatar: {
    width: 30,
    height: 30,
    borderRadius: 15,
    alignItems: 'center',
    justifyContent: 'center',
  },
  avatarUser: {
    backgroundColor: '#4A90E2',
  },
  avatarAI: {
    backgroundColor: 'rgba(187, 224, 255, 0.2)',
    borderWidth: 1,
    borderColor: '#BBE0FF',
  },
  avatarText: {
    fontSize: 12,
    fontWeight: '600',
    color: Colors.white,
  },
  messageBubble: {
    maxWidth: '80%',
    padding: 12,
    borderRadius: 16,
  },
  messageBubbleUser: {
    backgroundColor: 'rgba(187, 224, 255, 0.15)',
    borderWidth: 1,
    borderColor: 'rgba(187, 224, 255, 0.3)',
  },
  messageBubbleAI: {
    backgroundColor: 'rgba(255, 255, 255, 0.05)',
    borderWidth: 1,
    borderColor: 'rgba(255, 255, 255, 0.1)',
  },
  messageText: {
    fontSize: 14,
    color: Colors.white,
    lineHeight: 20,
  },
  recipesContainer: {
    marginTop: 12,
    gap: 12,
  },
  recipeCard: {
    backgroundColor: 'rgba(187, 224, 255, 0.1)',
    borderRadius: 12,
    padding: 14,
    borderWidth: 1,
    borderColor: 'rgba(187, 224, 255, 0.2)',
  },
  recipeHeader: {
    marginBottom: 12,
  },
  recipeName: {
    fontSize: 16,
    fontWeight: '600',
    color: '#BBE0FF',
    marginBottom: 8,
  },
  recipeStats: {
    flexDirection: 'row',
    gap: 15,
  },
  recipeStat: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 4,
  },
  recipeStatText: {
    fontSize: 12,
    color: 'rgba(255,255,255,0.7)',
  },
  sectionLabel: {
    fontSize: 12,
    fontWeight: '600',
    color: Colors.white,
    marginTop: 8,
    marginBottom: 6,
  },
  ingredientItem: {
    fontSize: 12,
    color: 'rgba(255,255,255,0.8)',
    marginLeft: 8,
    lineHeight: 18,
  },
  instructions: {
    fontSize: 12,
    color: 'rgba(255,255,255,0.8)',
    lineHeight: 18,
  },
  typingIndicator: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 12,
  },
  typingDots: {
    flexDirection: 'row',
    alignItems: 'center',
    gap: 8,
  },
  typingText: {
    fontSize: 12,
    color: 'rgba(255,255,255,0.5)',
  },
  inputContainer: {
    flexDirection: 'row',
    alignItems: 'flex-end',
    paddingHorizontal: 23,
    paddingVertical: 12,
    gap: 10,
    borderTopWidth: 1,
    borderTopColor: 'rgba(255,255,255,0.1)',
  },
  input: {
    flex: 1,
    backgroundColor: 'rgba(255,255,255,0.1)',
    borderRadius: 20,
    paddingHorizontal: 16,
    paddingVertical: 10,
    fontSize: 14,
    color: Colors.white,
    maxHeight: 100,
  },
  sendButton: {
    width: 40,
    height: 40,
    borderRadius: 20,
    backgroundColor: Colors.primary,
    alignItems: 'center',
    justifyContent: 'center',
  },
  sendButtonDisabled: {
    backgroundColor: 'rgba(187, 224, 255, 0.3)',
  },
});
